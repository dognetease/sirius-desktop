(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{"/HT8":function(e,t,n){"use strict";var r=n("QsI/"),i=(n("Qavd"),n("VtSi")),o=n.n(i),s=n("6eCk"),a=n("0HE+"),c=n("uuCm"),u=n("Ngo4"),d=n("y3J0"),p=n("iNLM"),g=n("GPrg"),l=n("bLhz"),h=n("U3tI"),f=n("xvit"),m=n("iYKj"),b=Object(s.config)("profile"),v="",A={hl:"zh_CN",all_secure:1,secure:1,deviceid:"--",p:v=b&&b.startsWith("webmail")?"web":b&&b.startsWith("edm")||Object(c.l)()&&window.electronLib?"sirius":"web",support_verify_code:1,output:"json"},w={p:v,output:"json"},k={p:v,hl:"zh_CN",uid:"",all_secure:1,output:"json",origin:""},y={plain:1,md5:2,rsa:3},S=0,x=1,L={"Qiye-Header":"sirius"},C=function(){this.preLoginPassed=!1,this.currentNode="hz",this.keyOfAccount="",this.currentAccount=void 0,this.codeRetryTime=0,this.loginMethod="pass",this.autoLogin=!1,this.logout=!1,this.mailMode=g.a.getDefaulaMailModeVal(),this.corpSid="",this.unqCode="",this.currentAccountPwd="",this.loginIssueConfirmShowed=!1,this.currentWillLoginAccount=""},E=function(){function e(){this.subAccountBindInfo=null,this.changeHashUrl=/^#\/?((?:doc)|(?:sheet)|(?:share)|(?:unitable))/i,this.encryptedPwdHead="encrypted:[",this.encryptedPwdTail="]",this.autoFillPwdMd5="",this.addAccountEventId=0,this.noLoginEvent=!1,this.impl=a.a.getDataTransApi(),this.systemApi=a.a.getSystemApi(),this.storeApi=a.a.getDataStoreApi(),this.actions=new C,this.eventApi=a.a.getEventApi(),this.accountApi=a.a.requireLogicalApi(c.a.accountApiImpl),this.dataTrackApi=a.a.requireLogicalApi(c.a.dataTrackerApiImp),this.loggerApi=a.a.requireLogicalApi(c.a.loggerApiImpl),this.performanceApi=a.a.requireLogicalApi(c.a.performanceImpl),this.name=c.a.loginApiImpl,this.noLoginStatus=!1,this.logoutProcessing=!1,this.productAuthApi=a.a.requireLogicalApi(c.a.productAuthApiImpl)}var t=e.prototype;return t.unpackLoginData=function(e){var t;return console.log("[login] return from network:"+(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.code),JSON.stringify(e.data),JSON.stringify(e.config.data)),this.loggerApi.track("login_request_returned",{res:e}),e.data},e.commonCatch=function(t){return t instanceof Error?e.getErrMsg(t.message):"string"==typeof t?e.getErrMsg(t):e.defaultErrInfo},e.getErrMsgCode=function(e){return e&&"LOGIN.PERMDENY"===e&&Object(c.l)()&&window.electronLib?"LINGXI.LOGIN.PERMDENY":e},e.getErrMsg=function(t,n){if(t&&t in u.a){var r=e.getErrMsgCode(t);return u.a[r]||u.a[t]}return t||n||e.defaultErrInfo},t.handleAccountAndDomain=function(e){return this.systemApi.handleAccountAndDomain(e)},t.getUrl=function(e){return this.systemApi.getUrl(e,this.actions.currentNode||this.storeApi.getCurrentNode())},t.loadStorageToDB=function(){var t=Object(r.a)(o.a.mark((function t(){var n,r,i,s,a,c,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!window||!window.isAccountBg){t.next=3;break}return t.abrupt("return",!0);case 3:return t.next=5,this.storeApi.get("isTransStorageAccount",e.storeConfig);case 5:if(n=t.sent,r=n.suc,i=n.data,!r||!i){t.next=10;break}return t.abrupt("return",!0);case 10:return s=this.systemApi.md5(e.AccountKey),t.next=13,this.storeApi.get(s,e.storeConfig);case 13:if(a=t.sent,c="",!a.suc||!a.data){t.next=19;break}return t.next=18,this.systemApi.decryptMsg(a.data);case 18:c=t.sent;case 19:if(console.log("[login] transfer account from ",c),!(c&&c.length>0)){t.next=28;break}return u=JSON.parse(c),t.next=24,this.accountApi.doSaveStorageAccount(u);case 24:return t.next=26,this.storeApi.del(s,e.storeConfig);case 26:return this.storeApi.putSync("isTransStorageAccount","ok",e.storeConfig),t.abrupt("return",!0);case 28:return t.abrupt("return",!1);case 31:return t.prev=31,t.t0=t.catch(0),console.error("[login] loadStorageToDB error",t.t0),t.abrupt("return",!1);case 35:case"end":return t.stop()}}),t,this,[[0,31]])})));return function(){return t.apply(this,arguments)}}(),t.isPreloginNeedUpdate=function(e){var t=this.actions,n=t.currentPreloginRequest,r=t.preLoginPassed,i=t.currentPreloginResponse;return!(r&&i&&n)||(1===n.type?!(e.mobile===n.mobile&&e.sendCodeType===n.sendCodeType):!(e.domain===n.domain&&e.account_name===n.account_name))},t.preLoginCheck=function(e){return this.impl.get(this.getUrl("newPreLoginCheck")+"?email="+e).then((function(e){var t=e.data;return!!(null==t?void 0:t.data)&&t.data})).catch((function(e){return console.log("[login] pre login check error",e),!0}))},t.preLogin=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,d,p,h,f,m;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isPreloginNeedUpdate(n)){t.next=2;break}return t.abrupt("return",Promise.resolve(this.actions.currentPreloginResponse));case 2:if(i=n.type||0,s=!0,!(0===i)){t.next=9;break}return t.next=8,this.preLoginCheck("a@"+n.domain);case 8:s=t.sent;case 9:if(!s){t.next=33;break}return this.actions.currentPreloginRequest=n,a=l.a.getIsNeteaseDomain(n.domain),c=a?"corpPreLogin":"preLogin",t.next=15,this.impl.post(this.getUrl(c),n);case 15:if(d=t.sent,p=this.unpackLoginData(d),h=this.actions,f=g.a.getMaiModeFromPreLoginResponse(p),h.mailMode=f,m=g.a.getIsCorpMailMode(f),"200"!==String(p.code)){t.next=27;break}return p.data.err=!1,h.preLoginPassed=!0,h.currentPreloginResponse=p.data,m&&(h.corpSid=null===(r=p.data)||void 0===r?void 0:r.sid),t.abrupt("return",p.data);case 27:return h.preLoginPassed=!1,h.currentPreloginResponse=void 0,m&&(h.corpSid=""),p.data.err=!0,p.data.errmsg=e.getErrMsg(p.msgCode),t.abrupt("return",p.data);case 33:return t.abrupt("return",Promise.resolve({err:!0,errmsg:u.a["ERR.LOGIN.DOMAINDENY"]}));case 34:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.doPreLogin=function(t){var n,r=this.handleAccountAndDomain(t);if(!g.a.checkAccountAndDomain(r))return Promise.resolve(g.a.getInputEmailErrorMsg());var i=Object.assign(Object.assign({},w),{account:t,account_name:r.account,domain:r.domain,mobile:null===(n=this.actions.currentPreloginRequest)||void 0===n?void 0:n.mobile});return this.preLogin(i).then(this.handlePreLoginData.bind(this)).catch(e.commonCatch)},t.doMobilePreLogin=function(){var t=Object(r.a)(o.a.mark((function t(n,r){var i;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===r&&(r=1),t.prev=1,t.next=4,this.preLogin(Object.assign(Object.assign({},w),{mobile:n,type:1,sendCodeType:r}));case 4:return i=t.sent,t.abrupt("return",this.handlePreLoginData(i));case 8:return t.prev=8,t.t0=t.catch(1),t.abrupt("return",e.commonCatch(t.t0));case 11:case"end":return t.stop()}}),t,this,[[1,8]])})));return function(){return t.apply(this,arguments)}}(),t.handlePreLoginData=function(t){if(t.locked)return this.eventApi.sendSysEvent({eventName:"error",eventData:u.a.EXP_AUTH_USER_STATUS_LOCKED,eventSeq:0,eventStrData:"warn"}),Promise.reject(new Error("prelogin fail , account locked"));if(t.node){if(this.actions.preLoginPassed=!1,this.actions.currentPreloginResponse=void 0,this.actions.currentNode!==t.node){if(!["hz","bj"].includes(t.node))return{errMsg:"不支持的节点"+t.node,err:!0};this.setupNodeInfo(t.node).then();var n=this.actions.currentPreloginRequest,r=n.account,i=n.mobile,o=n.type;return"mail"===(void 0===o?"mail":o)?this.doPreLogin(r):this.doMobilePreLogin(i)}return e.defaultErrInfo}this.setupNodeInfo(this.actions.currentNode).then();var s=t.errmsg?e.getErrMsg(t.errmsg):"";return s?(t.err=!0,t.errmsg=s):(t.isCorpMailMode=g.a.getIsCorpMailMode(this.actions.mailMode),t.sid=this.actions.corpSid),t},t.setupNodeInfo=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.actions.currentNode=t,this.storeApi.setCurrentNode(t),n){e.next=6;break}return r={eventName:"preLogin",eventData:t,eventSeq:0,eventStrData:"warn"},e.next=6,this.eventApi.sendSysEvent(r)||Promise.resolve();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.disableBackgroundDB=function(e){try{Object(c.l)()&&window.bridgeApi&&window.bridgeApi.master&&(window.bridgeApi.master.forbiddenBbWin4CurrPage(),!this.systemApi.isElectron()&&e&&window.bridgeApi.master.removeSubPageInWeb())}catch(t){console.error("diableBackgroundDBWin",t)}},t.enableBackgroundDB=function(){try{if(this.systemApi.getIsLowMemoryModeSync())return;Object(c.l)()&&window.bridgeApi&&window.bridgeApi.master&&window.bridgeApi.master.enableBbWin4CurrPage()}catch(e){console.error("enableBackgroundDB",e)}},t.doAutoLogin=function(){var t=Object(r.a)(o.a.mark((function t(n,r){var i,s,a,u,d,l;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=setTimeout((function(){"prod"===c.c&&p.h.reload()}),95e3),t.prev=1,this.noLoginEvent=!!r,this.isSameAccount(n)||this.systemApi.isBkLoginInit()){t.next=6;break}return t.next=6,this.doLogout(!0,!0);case 6:if(console.log("[login] finish logout !!!!!- "),!this.systemApi.isElectron()||!window.electronLib){t.next=31;break}return t.next=10,this.getAccountStored(n);case 10:if(a=t.sent,!g.a.getIsCorpMailMode(null===(i=null==a?void 0:a.prop)||void 0===i?void 0:i.mailMode)){t.next=14;break}return t.next=14,window.electronLib.appManage.clearCookieStore();case 14:if(!((u=null==a?void 0:a.cookies)&&u.length>0)){t.next=31;break}if(t.prev=16,!this.systemApi.isBkLoginInit()){t.next=23;break}return d=this.systemApi.getCurrentSessionName(),t.next=21,window.electronLib.appManage.setCookieStore({cookies:u,sessionName:d||""});case 21:t.next=25;break;case 23:return t.next=25,window.electronLib.appManage.setCookieStore(u);case 25:console.log("[login]  finish seting cookies !!!!!- ",u),t.next=31;break;case 28:t.prev=28,t.t0=t.catch(16),console.warn("[login] setCookieStore error",t.t0);case 31:return t.next=33,this.autoLogin(n);case 33:return l=t.sent,t.abrupt("return",l);case 37:return t.prev=37,t.t1=t.catch(1),t.abrupt("return",{pass:!1,errmsg:e.commonCatch(t.t1)||"未知错误"});case 40:return t.prev=40,this.noLoginEvent=!1,clearTimeout(s),t.finish(40);case 44:case"end":return t.stop()}}),t,this,[[1,37,40,44],[16,28]])})));return function(){return t.apply(this,arguments)}}(),t.corpAutoLogin=function(){var t=Object(r.a)(o.a.mark((function t(n){var i,s,a,c=this;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=Math.floor((new Date).getTime()/1e3).toString(),s={account_name:n.accountName,domain:n.domain,sid:n.sessionId,accessToken:n.accessToken,timestamp:i,signature:l.a.getSignForCorpRenewSid(n.accessToken,n.accessSecret,i)},a=this.getUrl("corpMailRenewSid"),t.abrupt("return",this.impl.post(a,s).then((function(e){return e.data})).then((function(t){return String(null==t?void 0:t.code)===l.a.CONSTANTS.CORP_API_SUCCESS_CODE?{pass:!0,res:null==t?void 0:t.data}:{pass:!1,errmsg:e.getErrMsg(null==t?void 0:t.msgCode),res:t}})).then(function(){var e=Object(r.a)(o.a.mark((function e(t){var r,i,s,a,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.pass){e.next=13;break}return i=n.accountName+"@"+n.domain,s=null===(r=t.res)||void 0===r?void 0:r.sid,e.next=5,c.corpGetNewUserWithNewSid(i,s);case 5:if(!(a=e.sent)){e.next=12;break}return u=l.a.getResponseLoginDataFromUser(a),e.next=10,c.corpLoginSucceed(u);case 10:e.next=13;break;case 12:t.pass=!1;case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()).catch((function(t){return t&&"string"==typeof t&&"NETWORK.ERR.TIMEOUT"===t?{pass:!1,timeout:!0,errmsg:"请求超时"}:{pass:!1,errmsg:e.commonCatch(t)}})));case 4:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.isSameAccount=function(e){var t=this.systemApi.getCurrentUser();return e===(null==t?void 0:t.id)},t.doSubAccountAutoLogin=function(){var e=Object(r.a)(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=this.systemApi.getCurrentAgentAccount().email){e.next=4;break}return e.abrupt("return",{pass:!1,errmsg:"无子账号"});case 4:return e.next=6,this.loginAgentEmail(t,"persist:sirius",this.systemApi.getCurrentSessionName()||"");case 6:return n=e.sent,e.abrupt("return",{pass:n.success,errmsg:n.errMsg||""});case 10:return e.prev=10,e.t0=e.catch(0),console.error("doSubAccountAutoLogin-error",e.t0),e.abrupt("return",{pass:!1,errmsg:e.t0.mesage||"子账号登录接口出错"});case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),t.autoLogin=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d,p,h,f,m,b,v,A,w,k;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.getAccountStored(n);case 3:if(i=t.sent,console.warn("[login autoLogin] account",i,this.systemApi.getCurrentUser()),i){t.next=7;break}return t.abrupt("return",{errmsg:"无登录账号",pass:!1});case 7:if(this.loggerApi.track("login_start_autoLogin",{loginAccount:i}),s=i.refreshToken,a=i.refreshTokenExpire,c=i.id,u=i.pwd,d=i.prop,p=i.loginAccount,console.log("[login] re login using account info:",i),window.isBridgeWorker&&this.systemApi.closeWindow(!1,!0),h=null==d?void 0:d.mailMode,!g.a.getIsCorpMailMode(h)){t.next=15;break}return f=l.a.getCorpAutoLoginParams(i),t.abrupt("return",this.corpAutoLogin(f));case 15:if(m=this.handleAccountAndDomain(p||c),b=m.account,v=m.domain,!s||!a){t.next=24;break}return u&&this.storePwd(u,2),this.loggerApi.track("login_doRefreshTokenLogin_autoLogin",{loginAccount:i}),t.next=21,this.doRefreshTokenLogin({tokenExpire:a||0,token:s||"",account_name:b,domain:v});case 21:if(!(A=t.sent).pass){t.next=24;break}return t.abrupt("return",A);case 24:if(!this.getIsAccountBg()){t.next=30;break}if(w=this.systemApi.getCurrentSubAccount().email,k=this.systemApi.getCurrentAgentAccount().email,w===k){t.next=30;break}return t.abrupt("return",this.doSubAccountAutoLogin());case 30:if(!u||u===e.accountPwdAutoFilled||u===this.autoFillPwdMd5){t.next=33;break}return this.loggerApi.track("login_pwd_autoLogin",{loginAccount:i}),t.abrupt("return",this.doLogin({account:c,isAutoLogin:!0,pwd:e.accountPwdAutoFilled},(null==A?void 0:A.timeout)?1:2));case 33:return t.abrupt("return",{pass:!1,errmsg:"无登录账号"});case 36:return t.prev=36,t.t0=t.catch(0),console.warn("[login] error occured when autoLogin:",t.t0),t.abrupt("return",{errmsg:(null===(r=t.t0)||void 0===r?void 0:r.msg)||"预登录接口发生未知错误",pass:!1});case 40:case"end":return t.stop()}}),t,this,[[0,36]])})));return function(){return t.apply(this,arguments)}}(),t.getAccountStored=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t,r=this.systemApi.getCurrentUser(),n||(n=null==r?void 0:r.id),n!==(null==r?void 0:r.id)||!(null==r?void 0:r.isSharedAccount)){e.next=5;break}return e.abrupt("return",r);case 5:if(!n){e.next=10;break}return e.next=8,this.accountApi.doGetAccountInfo([n]);case 8:return i=e.sent,e.abrupt("return",i[0]);case 10:return e.abrupt("return",void 0);case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.corpLoginSucceed=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=null,n&&(s=n),e.next=4,this.loginSucceed({isCorpMail:!0,uid:t.uid,nickname:t.nickname||(null==s?void 0:s.nickName),cookieName:t.sid,orgName:t.orgName||(null==s?void 0:s.company),cnName:t.cookieName,accessToken:t.accessToken||(null===(r=null==s?void 0:s.prop)||void 0===r?void 0:r.accessToken),accessSecret:t.accessSecret||(null===(i=null==s?void 0:s.prop)||void 0===i?void 0:i.accessSecret),nonce:t.nonce,mobile:t.mobile});case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.corpGetNewUserWithNewSid=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getAccountStored(t);case 3:if(r=e.sent){e.next=6;break}return e.abrupt("return",null);case 6:return r.sessionId=n,e.abrupt("return",r);case 10:return e.prev=10,e.t0=e.catch(0),console.error("[login] corpReNewSidSucceed",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),t.clearCookies=function(){var e=Object(r.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=!1),e.prev=1,!this.systemApi.isElectron()||!window.electronLib){e.next=4;break}return e.abrupt("return",window.electronLib.windowManage.clearLocalData("cookies"));case 4:return e.abrupt("return",this.systemApi.clearUserAuthCookie(!1,t));case 7:return e.prev=7,e.t0=e.catch(1),console.error("clearCookies error",e.t0),e.abrupt("return",Promise.resolve());case 11:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(){return e.apply(this,arguments)}}(),t.tryReportLoginSuccess=function(e){try{this.requestReportSuccApi(e).catch((function(e){console.error("[login] report-error",e)}))}catch(t){console.error("[login] report-error",t)}},t.doCorpLogin=function(){var t=Object(r.a)(o.a.mark((function t(n,i,s){var a,c,u,d,p,g,h,f=this;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=this.actions.corpSid,c=this.handleAccountAndDomain(n),t.next=4,l.a.getRequestParamsAsync({sid:a,account:c.account,domain:c.domain,deviceId:A.deviceid});case 4:return u=t.sent,t.next=7,this.getAccountStored(n);case 7:return d=t.sent,p={},d&&(p=l.a.getReLoginParams(d)),g=Object.assign(Object.assign(Object.assign(Object.assign({},p||{}),A),u),{support_verify_code:1,verify_code:s,password:i}),h=this.getUrl("corpMailPwdLogin"),t.abrupt("return",this.impl.post(h,g).then((function(e){return e.data})).then((function(e){return String(null==e?void 0:e.code)===l.a.CONSTANTS.CORP_API_SUCCESS_CODE?(f.storeCurrentAccount({account:n,pwd:l.a.CONSTANTS.CORP_DEFAULT_PASSWORD}),e.data):{pass:!1,err:!0,errMsg:null==e?void 0:e.msgCodeDesc,errCode:null==e?void 0:e.msgCode}})).then((function(e){return f.handleLoginResponse(e)})).then(function(){var e=Object(r.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.pass){e.next=5;break}return e.next=3,f.corpLoginSucceed(t.res,d);case 3:e.next=6;break;case 5:"ERR.SESSIONNULL"===t.errCode&&(f.actions.preLoginPassed=!1);case 6:return e.abrupt("return",t);case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()).catch((function(t){return console.error("[login] doCorpLogin error:",t),{errmsg:e.commonCatch(t),pass:!1}})));case 13:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.doLogin=function(){var t=Object(r.a)(o.a.mark((function t(n,r){var i,s,a,c,d,p,l,h,f,m,b,v,w,k,S,x,L,C,E;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=n.account,c=n.pwd,d=n.isAutoLogin,p=n.verifyCode,l=n.isUnLockApp,h=void 0!==l&&l,f=this.handleAccountAndDomain(a),g.a.checkAccountAndDomain(f)){t.next=4;break}return t.abrupt("return",{errmsg:g.a.getInputEmailErrorMsg(),pass:!1});case 4:if(!g.a.getIsCorpMailMode(this.actions.mailMode)){t.next=6;break}return t.abrupt("return",this.doCorpLogin(a,c,p));case 6:if(m=!1,d||(m=!this.actions.preLoginPassed),!m){t.next=14;break}return t.next=11,this.doPreLogin(a);case 11:if("object"!=typeof(b=t.sent)||!(null===(i=b.errmsg)||void 0===i?void 0:i.length)){t.next=14;break}return t.abrupt("return",{errmsg:u.a["LOGIN.ILLEGAL.STATE"]+":"+b.errmsg,pass:!1});case 14:return t.next=16,this.getS({originPwd:c,originAccount:a,rsaEncrypt:!d,md5Encrypt:d});case 16:if(v=t.sent,w=v.pwd,k=v.type,S=(null===(s=this.actions.currentPreloginResponse)||void 0===s?void 0:s.pubid)||"",x=Object.assign(Object.assign({},A),{passtype:y[k],account_name:f.account,domain:f.domain,password:w,pubid:S}),"rsa"!==k||S){t.next=23;break}return t.abrupt("return",{errmsg:u.a["PRELOGIN.ERR"],pass:!1});case 23:return this.storePwd("md5"===k?w:c,y[k]),this.actions.loginMethod="pass",this.actions.currentWillLoginAccount=a,h&&(x._session="memory-"+(new Date).getTime()),t.prev=27,t.next=30,this.login(x,r||1);case 30:if(L=t.sent,!h){t.next=36;break}return C=L.data||{},L.msgCode&&(C.errMsg=L.msgCode),this.actions.preLoginPassed=!1,t.abrupt("return",{pass:["entry","mauth","2fa","gauth","passchange"].includes(C.location),errmsg:e.getErrMsg(C.errMsg)});case 36:return t.next=38,this.processLoginResult(L);case 38:return(null==(E=t.sent)?void 0:E.pass)&&!d&&this.tryReportLoginSuccess(a),t.abrupt("return",E);case 43:if(t.prev=43,t.t0=t.catch(27),!t.t0||"string"!=typeof t.t0||"NETWORK.ERR.TIMEOUT"!==t.t0){t.next=47;break}return t.abrupt("return",{pass:!1,timeout:!0,errmsg:"请求超时"});case 47:return t.abrupt("return",Promise.reject(t.t0));case 48:case"end":return t.stop()}}),t,this,[[27,43]])})));return function(){return t.apply(this,arguments)}}(),t.doMobileValidateAccountLogin=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c,d,p,g,l,h,f,m;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.account,i=t.password,s=t.reg_code,a=t.reg_mobile,c=t.currentAccountNode,d=this.handleAccountAndDomain(r),p=d.account,g=d.domain,p&&g){e.next=5;break}return console.warn("input data illegal"),e.abrupt("return",Promise.reject(u.a["ERR.LOGIN.ILLEGALINPUT"]));case 5:if(!c||c===this.storeApi.getCurrentNode()){e.next=8;break}return e.next=8,this.doPreLogin(r);case 8:return e.next=10,this.getS({originAccount:r,originPwd:i,rsaEncrypt:!0});case 10:return l=e.sent,h=l.pwd,f=l.type,m=(null===(n=this.actions.currentPreloginResponse)||void 0===n?void 0:n.pubid)||"",e.abrupt("return",this.mobileLogin({reg_code:s,reg_mobile:a,unq_code:this.actions.unqCode,domain:g,account_name:p,password:h,pubid:m,passtype:y[f]}));case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doMobileTokenLogin=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d,p,g,l,h;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!this.systemApi.getCurrentUser()){t.next=4;break}return t.next=4,this.doLogout(!0,!0);case 4:return this.loggerApi.track("login_doMobileTokenLogin_request",n),t.next=7,this.impl.post(this.systemApi.getUrl("mobileTokenLogin"),Object.assign(Object.assign({},w),n));case 7:if(i=t.sent,s=i.data,c=(a=s||{}).code,u=a.msgCode,d=a.data,this.loggerApi.track("login_doMobileTokenLogin_return",d),console.log("[login web] doMobileTokenLogin",d,c),"200"!==String(c)||!d){t.next=18;break}return p=d.refreshToken,g=d.refreshTokenExpire,l=n.account_name,h=n.domain,this.storeCurrentAccount({account:l+"@"+h,refreshToken:p,refreshTokenExpire:g,mobile:null===(r=this.actions.currentPreloginRequest)||void 0===r?void 0:r.mobile}),console.log("[login_impl] doMobileTokenLogin",d),t.abrupt("return",this.requestDoorApi(Object.assign(Object.assign({},d),{pass:!0,res:d})));case 18:return t.abrupt("return",{pass:!1,errmsg:e.getErrMsg(u),errCode:u});case 21:return t.prev=21,t.t0=t.catch(0),console.error("[login_impl] doMobileTokenLogin error",t.t0,"params",n),t.abrupt("return",{pass:!1,errmsg:e.commonCatch(t.t0)});case 25:case"end":return t.stop()}}),t,this,[[0,21]])})));return function(){return t.apply(this,arguments)}}(),t.mobileLogin=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d,p,g,l,h,f;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r={pass:!1,errmsg:""},t.prev=1,this.loggerApi.track("login_doMobileValidateAccountLogin_mobileLoginActive",n),t.next=5,this.impl.post(this.systemApi.getUrl("mobileLoginActive"),Object.assign(Object.assign({},n),A));case 5:if(i=t.sent,s=i.data,c=(a=s||{}).code,u=void 0===c?"":c,d=a.data,p=a.msgCode,"200"!==String(u)||!d){t.next=15;break}return g=d.token,l=d.account_name,h=d.domain,t.next=12,this.doMobileTokenLogin({token:g,account_name:l,domain:h});case 12:r=t.sent,t.next=20;break;case 15:console.error("[login_impl] mobileLogin error",s),this.refreshStatus(),f=e.getErrMsg(p),"ERR.SESSIONNULL"===p&&(f="您长时间未操作，请您返回登录页面重新登录"),r=Object.assign(Object.assign({},r),{errmsg:f});case 20:t.next=26;break;case 22:t.prev=22,t.t0=t.catch(1),console.error("[login_impl] mobileLogin error",t.t0),r=Object.assign(Object.assign({},r),{errmsg:e.commonCatch(t.t0)});case 26:return t.abrupt("return",r);case 27:case"end":return t.stop()}}),t,this,[[1,22]])})));return function(){return t.apply(this,arguments)}}(),t.getMobileLoginToken=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.impl.post(this.systemApi.getUrl("getMobileLoginToken"),Object.assign(Object.assign({},n),w));case 3:if(r=t.sent,i=r.data,console.log("zzzzzzzzzh getMobileLoginToken",i),a=(s=i||{}).code,c=void 0===a?"":a,u=s.data,d=s.msgCode,"200"!==String(c)||!u){t.next=9;break}return t.abrupt("return",{success:!0,data:u});case 9:return t.abrupt("return",{success:!1,message:e.getErrMsg(d),code:d});case 12:return t.prev=12,t.t0=t.catch(0),console.error("[login_impl] getMobileLoginToken error",t.t0),t.abrupt("return",{success:!1,message:e.commonCatch(t.t0)});case 16:case"end":return t.stop()}}),t,this,[[0,12]])})));return function(){return t.apply(this,arguments)}}(),t.doMobileCodeLogin=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c,u,d;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getMobileLoginToken(t);case 2:if(n=e.sent,r=n.success,i=n.message,s=n.code,a=n.data,console.log("[login web] getMobileLoginToken",a,r),!r){e.next=11;break}return c=a.token,u=a.account_name,d=a.domain,e.abrupt("return",this.doMobileTokenLogin({token:c,account_name:u,domain:d}));case 11:return e.abrupt("return",{pass:!1,errmsg:i,errCode:s});case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doMobileBindAccountLogin=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.doPreLogin(this.accountApi.doGetAccount({accountName:t.account_name,domain:t.domain}));case 2:return e.next=4,this.getMobileLoginToken(Object.assign(Object.assign({},t),{type:1}));case 4:if(n=e.sent,r=n.success,i=n.message,s=n.data,!r){e.next=11;break}return a=s.token,c=s.account_name,u=s.domain,e.abrupt("return",this.doMobileTokenLogin({token:a,account_name:c,domain:u}));case 11:return e.abrupt("return",{pass:!1,errmsg:i});case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doUpdateRefreshToken=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d,p;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.loggerApi.track("login_checkRefreshToken_request",n),t.next=3,this.impl.post(this.systemApi.getUrl("refreshToken"),Object.assign(Object.assign({},w),n));case 3:if(r=t.sent,i=r.data,a=(s=i||{}).code,c=s.msgCode,u=s.data,this.loggerApi.track("login_checkRefreshToken_return",{code:a,msgCode:c,res:u}),"200"!==String(a)||!u){t.next=12;break}return d=u.token,p=u.expire,t.next=11,this.accountApi.doUpdateAccountList([{id:this.accountApi.doGetAccount({accountName:n.account_name,domain:n.domain}),refreshToken:d,refreshTokenExpire:p}]);case 11:return t.abrupt("return",{success:!0,data:Object.assign(Object.assign({},n),{token:d})});case 12:return t.abrupt("return",{success:!1,message:e.getErrMsg(c)});case 13:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.doRefreshTokenLogin=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d,p,g,l,h,f,m,b,v,A,k,y;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.doPreLogin(this.accountApi.doGetAccount({accountName:n.account_name,domain:n.domain}));case 3:return this.loggerApi.track("login_refreshTokenLogin_request",n),t.next=6,this.impl.post(this.systemApi.getUrl("refreshTokenLogin"),Object.assign(Object.assign({},w),n));case 6:if(s=t.sent,a=s.data,u=(c=a||{}).code,d=c.msgCode,p=c.data,this.loggerApi.track("login_refreshTokenLogin_return",a),"200"!==String(u)||!p){t.next=21;break}return g=p.refreshToken,l=p.refreshTokenExpire,h=p.mobile,f=n.account_name,m=n.domain,b=f+"@"+m,this.actions.currentWillLoginAccount=b,this.storeCurrentAccount({account:b,refreshToken:g,refreshTokenExpire:l,mobile:h||(null===(r=this.actions.currentPreloginRequest)||void 0===r?void 0:r.mobile)}),v=this.systemApi.getCurrentUser(),A=!1,v&&v.isSharedAccount&&(A=!0,k=(null===(i=v.originAccount)||void 0===i?void 0:i.email)||""),console.log("[login_impl] doRefreshTokenLogin",p),t.abrupt("return",this.requestDoorApi(Object.assign(Object.assign({},p),{pass:!0,res:Object.assign({originAccount:k,isSharedAccountSwitch:A},p)})));case 21:return t.abrupt("return",{pass:!1,errmsg:e.getErrMsg(d)});case 24:if(t.prev=24,t.t0=t.catch(0),console.error("[login_impl] doRefreshTokenLogin error",t.t0,"params",n),!t.t0||"string"!=typeof t.t0||"NETWORK.ERR.TIMEOUT"!==t.t0){t.next=30;break}return this.loggerApi.track("login_refreshTokenLogin_request_timeout",{params:n}),t.abrupt("return",{pass:!1,timeout:!0,errmsg:"请求超时"});case 30:return y=e.commonCatch(t.t0),this.loggerApi.track("login_refreshTokenLogin_request_failed",{params:n,error:y}),t.abrupt("return",{pass:!1,errmsg:y});case 33:case"end":return t.stop()}}),t,this,[[0,24]])})));return function(){return t.apply(this,arguments)}}(),t.storePwd=function(e,t){void 0===t&&(t=1);var n=e;if(2!==t){if(this.testPwdStyleIsNew(n)){var r=n.replace(this.encryptedPwdHead,"").replace(this.encryptedPwdTail,"");n=this.systemApi.decryptByKey(r,this.storeApi.getUUID())}n=this.systemApi.md5(e)}this.storeCurrentAccount({pwd:n})},t.storeCurrentAccount=function(e){var t=this.actions.currentAccount||{},n=t.a,r=t.k,i=t.tExpire,o=t.t,s=t.mobile,a=t.lastLogin,c=void 0===a?Date.now():a,u=e.account,d=void 0===u?n:u,p=e.refreshToken,g=void 0===p?o:p,l=e.mobile,h=void 0===l?s:l,f=e.refreshTokenExpire,m=void 0===f?i:f,b=e.pwd,v=void 0===b?r:b;this.actions.currentAccount={a:d||"",t:g,k:v,mobile:h,tExpire:m,lastLogin:c}},t.login=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,s,a,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0===n?2:n,e.prev=1,r=decodeURIComponent(window.location.hash),i=r.match(this.changeHashUrl),s=(null==i?void 0:i.length)||0,a=s>1?i[1]:"login",e.next=8,this.impl.post(this.impl.buildUrl(this.getUrl("login"),{_from:a}),t,{});case 8:return c=e.sent,u=this.unpackLoginData(c),e.abrupt("return",u);case 13:if(e.prev=13,e.t0=e.catch(1),!e.t0||"string"!=typeof e.t0||"NETWORK.ERR.TIMEOUT"!==e.t0){e.next=20;break}if(!(n>0)){e.next=20;break}return e.next=19,Object(p.i)(1500*(3-n)+500);case 19:return e.abrupt("return",this.login(t,n-1));case 20:return e.abrupt("return",Promise.reject(e.t0));case 21:case"end":return e.stop()}}),e,this,[[1,13]])})));return function(){return e.apply(this,arguments)}}(),e.processLogin=function(e){var t=e.data||{};return e.msgCode&&(t.errMsg=e.msgCode),t},t.loginDoorEnter=function(e){return e.pass?this.requestDoorApi(e):e},t.requestDoorApi=function(t){var n=this,i=t.res,s=i.nickname,a=i.uid,c=i.orgName,u=i.cookieName,d=i.isSharedAccountSwitch,p=i.originAccount,g=k,l=a||"";if(g.uid=l,d)if(p)g.origin=p;else{var h=this.systemApi.getCurrentUser();h&&(g.origin=h.id)}return this.impl.get(this.getUrl("loginDoor"),g).then(this.unpackLoginData.bind(this)).then(function(){var i=Object(r.a)(o.a.mark((function r(i){var a;return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if("200"!==String(i.code)){r.next=5;break}return a=i.data.sid,r.next=4,n.loginSucceed({isSharedAccountSwitch:d,uid:l,nickname:s,cookieName:a,orgName:c,cnName:u});case 4:return r.abrupt("return",t);case 5:return r.abrupt("return",{errmsg:e.getErrMsg(i.msgCode),pass:!1});case 6:case"end":return r.stop()}}),r)})));return function(){return i.apply(this,arguments)}}()).catch((function(t){return console.log("[login] door api error",t),{errmsg:e.commonCatch(t),pass:!1}}))},t.handleLoginResponse=function(t){this.loggerApi.track("login_network_return",t),console.log("[login] login_network_return:"+JSON.stringify(t));var n=t.pass,r=t.location,i=t.errMsg,o=t.mobile,s=t.uid,a=t.refreshToken,c=t.refreshTokenExpire,u=t.isSharedAccountSwitch;if(s&&this.actions.currentPreloginRequest){var d=this.systemApi.handleAccountAndDomain(s);this.actions.currentPreloginRequest.account_name=d.account,this.actions.currentPreloginRequest.domain=d.domain}return"entry"===r&&n?(this.storeCurrentAccount({account:s,refreshToken:a,refreshTokenExpire:c}),{errmsg:i||"",pass:!0,res:t,isSharedAccountSwitch:u}):("code"===this.actions.loginMethod&&(this.actions.codeRetryTime+=1),this.dataTrackApi.track("login_not_pass_occurred",{location:r}),"mauth"===r?{errmsg:"",secondCheck:!0,mobile:o,showConfig:!1,pass:!1,res:t}:"2fa"===r?{errmsg:"",secondCheck:!0,showConfig:!0,pass:!1,res:t}:"gauth"===r?{errmsg:"暂不支持将军令登录",pass:!1,res:t}:"passchange"===r?{errmsg:"",showResetPass:!0,pass:!1,res:t}:{errmsg:e.getErrMsg(i),pass:!1,errCode:t.errCode,res:t})},t.getIsAddAccountPage=function(){return this.systemApi.getIsAddAccountPage()||this.systemApi.getIsAddSubAccountPage()||this.systemApi.getIsAddPersonalSubAccountPage()},t.loginSucceed=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c,u,d,p=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.uid,r=t.isSharedAccountSwitch,i=void 0!==r&&r,s=t.isCorpMail,a=void 0!==s&&s,this.impl.setLogoutStatus(!1),e.next=4,this.getAccountStored(n);case 4:return c=e.sent,e.next=7,this.setLoginSucceedCookie();case 7:return u=e.sent,d=this.setLoginSucceedUser({storeCurrentUser:c,data:t,cookies:u}),e.next=11,this.storeApi.setLastAccount(d);case 11:return console.log("[login] login account stored ",d),e.next=14,this.sendLoginEvent(d);case 14:return e.next=16,this.productAuthApi.saveAuthConfigFromNet();case 16:return this.setLoginSucceedAccountStatus(),this.eventApi.sendSysEvent({eventName:"initModule",eventStrData:"account"}),e.next=20,this.handleLoginSucceedBgAccount({isSharedAccountSwitch:i,user:d});case 20:a||this.bindAccountDevice().then().catch((function(e){console.warn("[login] bind account ",e)})),this.systemApi.getActiveUserTrackParams(i).then((function(e){p.dataTrackApi.track("pc_dailyActiveUser",Object.assign({type:"loginResult"},e||{}))}));case 22:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.setOriginAccount=function(e){var t,n=e.isSharedAccountSwitch,r=e.originAccountEmail,i=this.systemApi.getCurrentUser();n&&r?t=i&&i.id!==r?{email:r,nickName:null==i?void 0:i.nickName,avatar:null==i?void 0:i.avatar}:{email:r,nickName:this.handleAccountAndDomain(r).account,avatar:""}:n&&i&&(t=i.originAccount?i.originAccount:{email:i.id||"",nickName:i.nickName||"",avatar:i.avatar||""});return t},t.setLoginSucceedUser=function(e){var t=e.data,n=e.storeCurrentUser,r=e.cookies,i=t.uid,o=t.nickname,s=void 0===o?"":o,a=t.cookieName,c=void 0===a?"":a,u=t.orgName,d=void 0===u?"":u,p=t.cnName,l=t.accessToken,h=void 0===l?"":l,f=t.accessSecret,m=void 0===f?"":f,b=t.isCorpMail,v=void 0!==b&&b,A=t.nonce,w=void 0===A?"":A,k=t.mobile,y=void 0===k?"":k,S=t.isSharedAccountSwitch,x=void 0!==S&&S,L=t.originAccountEmail,C=void 0===L?"":L,E=this.systemApi.md5(i||"__",!0),M=this.actions.currentAccount||{},P=M.mobile,O=M.t,I=M.tExpire,T=M.a,N=this.setOriginAccount({isSharedAccountSwitch:x,originAccountEmail:C}),j=i?this.handleAccountAndDomain(i):{},R=j.account,D=j.domain,U={nickName:s,avatar:(null==n?void 0:n.avatar)||"",contact:null==n?void 0:n.contact,lastLoginTime:Date.now(),sessionId:c,id:i,loginAccount:this.actions.currentWillLoginAccount,domain:D,accountName:R,accountMd5:E,cookies:r,node:this.actions.currentNode,mobile:v?y:P,refreshToken:O,refreshTokenExpire:I,company:d,isSharedAccount:x,originAccount:N,cnName:p,prop:{company:d,mailMode:v?g.a.getCorpMailModeVal():g.a.getHMailModeVal(),accessToken:h,accessSecret:m,nonce:w}};return T!==U.id&&(U.bmId=T),U},t.setLoginSucceedCookie=function(){var e=Object(r.a)(o.a.mark((function e(){var t,n,i=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=function(){var e=Object(r.a)(o.a.mark((function e(r){var s,a,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=1,s=i.getIsAddAccountPage(),a=i.getIsAccountBg(),c=i.systemApi.isBkLoginInit(),!(s||a||c)){e.next=13;break}if(!(u=i.systemApi.getCurrentSessionName())||!u.length){e.next=11;break}return e.next=10,window.electronLib.appManage.getSessionCookieStore({sessionName:u});case 10:t=e.sent;case 11:e.next=16;break;case 13:return e.next=15,window.electronLib.appManage.getCookieStore();case 15:t=e.sent;case 16:e.next=24;break;case 18:if(e.prev=18,e.t0=e.catch(1),console.warn(e.t0),!(r>0)){e.next=24;break}return e.next=24,n(r-1);case 24:case"end":return e.stop()}}),e,null,[[1,18]])})));return function(){return e.apply(this,arguments)}}(),e.next=3,n(2);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.setLoginSucceedAccountStatus=function(){this.actions.logout=!1,this.noLoginStatus=!1,this.logoutProcessing=!1},t.handleLoginSucceedBgAccount=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c,u,d;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.user,s=t.isSharedAccountSwitch,a=this.systemApi.isBkLoginInit(),c=this.getIsAccountBg(),u=this.getIsAddAccountPage(),c&&!u&&(i.mainAccount=this.systemApi.getMainAccount().email),!((d=!u&&!c&&!a)&&this.systemApi.isElectron()&&window.electronLib)){e.next=12;break}return e.next=9,window.electronLib.storeManage.set("app","initAccount","true");case 9:return e.next=11,this.createBKStableWindow();case 11:this.enableBackgroundDB();case 12:if(s){e.next=15;break}return e.next=15,this.accountApi.doSaveCurrentAccount(Object.assign(Object.assign({},i),{expired:!1,pwd:null===(n=this.actions.currentAccount)||void 0===n?void 0:n.k}));case 15:d&&!this.systemApi.isElectron()&&(null===(r=null===window||void 0===window?void 0:window.bridgeApi)||void 0===r?void 0:r.master)&&(this.enableBackgroundDB(),window.bridgeApi.master.createSubPageInWeb()),c&&!u&&this.eventApi.sendSysEvent({eventName:"subAccountDBChanged"});case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.createBKStableWindow=function(){var e=Object(r.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}if(!this.systemApi.getIsLowMemoryModeSync()){e.next=4;break}return e.abrupt("return",Promise.resolve());case 4:return e.abrupt("return",window.electronLib.windowManage.createWindow({type:"bkStable",manualShow:!0}).then((function(e){return console.log("!!! -- build app init window success -- !!!"),e})));case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.sendLoginEvent=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.getIsAddAccountPage()||this.systemApi.isBkLoginInit()||this.noLoginEvent)){e.next=3;break}return e.abrupt("return",Promise.resolve(""));case 3:return r={eventName:"login",eventData:t,eventSeq:0,eventStrData:n?"timeout_event":"event"},e.prev=4,i=this.eventApi.sendSysEvent(r)||Promise.resolve(""),e.next=8,i;case 8:return s=e.sent,e.abrupt("return",s);case 12:return e.prev=12,e.t0=e.catch(4),e.abrupt("return","");case 15:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(){return e.apply(this,arguments)}}(),t.getS=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,u,d,p,g,l,f,m,b,v,A;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=n.originPwd,u=n.originAccount,d=n.rsaEncrypt,p=n.md5Encrypt,u){t.next=3;break}throw new Error("无法找到帐户信息");case 3:if(a!==e.accountPwdAutoFilled){t.next=12;break}return t.next=6,this.getAccountStored(u);case 6:if(g=t.sent,l=null==g?void 0:g.pwd){t.next=10;break}throw new Error("无法获取用户密码");case 10:return console.log("[login] got password for "+h.a,l),t.abrupt("return",{pwd:l,type:"md5"});case 12:if(f=a,this.testPwdStyleIsNew(a)&&(m=a.replace(this.encryptedPwdHead,"").replace(this.encryptedPwdTail,""),f=this.systemApi.decryptByKey(m,this.storeApi.getUUID()),"dev"!==c.c&&"test"!==c.c&&"local"!==c.c||console.log("[login] got real pwd "+f)),!d){t.next=19;break}return b=(null===(r=this.actions.currentPreloginResponse)||void 0===r?void 0:r.modulus)||"",v=(null===(i=this.actions.currentPreloginResponse)||void 0===i?void 0:i.exponent)||"",A=(null===(s=this.actions.currentPreloginResponse)||void 0===s?void 0:s.rand)||"",t.abrupt("return",{pwd:this.systemApi.rsaEncrypt(b,v,A,f),type:"rsa"});case 19:if(!p){t.next=21;break}return t.abrupt("return",{pwd:this.systemApi.md5(f,!1),type:"md5"});case 21:return t.abrupt("return",{pwd:f,type:"plain"});case 22:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.testPwdStyleIsNew=function(e){return e?e.startsWith(this.encryptedPwdHead)&&e.endsWith(this.encryptedPwdTail):void 0},t.doOpenForgetPwdUrl=function(e,t){var n=c.d.forgetPwd;if(e&&t){var r=this.handleAccountAndDomain(t);l.a.getIsNeteaseDomain(r.domain)&&(n=l.a.CONSTANTS.NETEASE_RESET_PWD_URL)}return this.systemApi.openNewWindow(n),""},t.doOpenPromptPage=function(){return this.systemApi.openNewWindow(c.d.prompt),""},t.doLoadDataAndAutoLogin=function(){var e=Object(r.a)(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.systemApi.getCurrentUser()){e.next=3;break}return e.next=3,this.doLogout(!0,!1);case 3:return e.abrupt("return",this.storeApi.get(t,{prefix:"lg-",noneUserRelated:!0}).then((function(e){if(e&&e.suc&&e.data){var r=n.systemApi.decryptByKey(e.data,t);return JSON.parse(r)}})).then((function(e){if(e)return e;var r=n.systemApi.getUrl("getData");return n.impl.get(r).then((function(e){if(e.data&&e.data.success){var r=e.data.data;if(r){var i=n.systemApi.decryptByKey(r,t);return JSON.parse(i)}}return Promise.reject(new Error("未取得必要登录数据"))}))})).then((function(e){var t=e.account_name,r=e.password;return n.doLogin({account:t,pwd:r})})));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doOpenConfigPage=function(){return this.systemApi.openNewWindow(c.d.bindNewPwd),""},t.getIsLingxiWeb=function(){return!!Object(c.l)()&&((!window||!window.electronLib)&&!(b&&b.startsWith("webmail")))},t.sendVerifyCode=function(t){this.getIsLingxiWeb()&&(t.p="sirius");var n=this.impl.buildUrl(this.getUrl("sendCode"),Object.assign(Object.assign({},t),{type:t.sendCodeType}));return this.impl.get(n,{},{}).then(this.unpackLoginData.bind(this)).then((function(n){var r=n.code,i=n.msgCode;return"200"===String(r)?"":"ERR.LOGIN.MLOGINSMSREQ"===i&&2===t.sendCodeType?"今日此手机验证码获取次数已达到10次上限":e.getErrMsg(i)||"发送失败，请重试"})).catch((function(e){return console.warn(e),"发送失败，请重试"}))},t.doCorpSendMobileCode=function(){var t=Object(r.a)(o.a.mark((function t(){var n,r,i,s,a,c,u,d;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this.actions,r=n.corpSid,i=n.currentPreloginRequest,s=null==i?void 0:i.account_name,a=null==i?void 0:i.domain,t.next=5,l.a.getRequestParamsAsync({sid:r,account:s,domain:a,deviceId:A.deviceid});case 5:return c=t.sent,u=Object.assign(Object.assign({},A),c),"发送失败，请重试",d=this.getUrl("coreMailSendPhoneCode"),t.abrupt("return",this.impl.post(d,u).then((function(e){return e.data})).then((function(t){return"object"==typeof t&&String(t.code)===l.a.CONSTANTS.CORP_API_SUCCESS_CODE?"":e.getErrMsg(null==t?void 0:t.msgCode,"发送失败，请重试")})).catch((function(e){return console.error("[login] doCorpSendMobileCode error",e),"发送失败，请重试"})));case 10:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.doMobileVerifyCode=function(){var t=Object(r.a)(o.a.mark((function t(n,r){var i,s,a,c,u,d,p,g,l,h;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,i=this.impl.buildUrl(this.getUrl("mobileVerifyCode"),{code:n,p:v}),t.next=4,this.impl.post(i);case 4:if(s=t.sent,a=this.unpackLoginData(s),c=a.code,u=void 0===c?"":c,d=a.msgCode,p=a.data,"200"!==u.toString()){t.next=10;break}return g=p.accounts,l=p.unq_code,this.actions.unqCode=l,t.abrupt("return",{success:!0,data:this.accountApi.doTransMobileBindAccountList(g)});case 10:return console.error("[login_impl] doMobileVerifyCode error",s),h=e.getErrMsg(d),500===u&&("ERR. LOGIN. MLOGINSMSREO"===d?h=r?"当天已发送已发送10次":"当天已发送已发送20次":"ERR.SESSIONNULL"===d&&(h="验证码已失效，请重新获取验证码")),t.abrupt("return",{success:!1,message:h,code:u.toString()});case 16:return t.prev=16,t.t0=t.catch(0),console.error("[login_impl] doMobileVerifyCode error",t.t0),t.abrupt("return",{success:!1,message:e.commonCatch(t.t0)});case 20:case"end":return t.stop()}}),t,this,[[0,16]])})));return function(){return t.apply(this,arguments)}}(),t.doSendVerifyCode=function(){return this.actions.preLoginPassed&&this.actions.currentPreloginRequest?(this.actions.codeRetryTime=0,1!==this.actions.currentPreloginRequest.type&&g.a.getIsCorpMailMode(this.actions.mailMode)?this.doCorpSendMobileCode():this.sendVerifyCode(this.actions.currentPreloginRequest).catch(e.commonCatch)):Promise.resolve(u.a["ERR.ILLEGAL"])},t.loginWithCode=function(e){return this.impl.post(this.getUrl("mobileLogin"),e,{}).then(this.unpackLoginData.bind(this))},t.doCorpLoginWithCode=function(){var t=Object(r.a)(o.a.mark((function t(n){var i,s,a,c,u,d,p,g,h=this;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=this.actions,s=i.corpSid,a=i.currentPreloginRequest,c=null==a?void 0:a.account_name,u=null==a?void 0:a.domain,t.next=5,l.a.getRequestParamsAsync({sid:s,account:c,domain:u,deviceId:A.deviceid});case 5:return d=t.sent,p=Object.assign(Object.assign(Object.assign({},A),d),{code:n,passtype:2}),g=this.getUrl("corpMailPhoneCodeLogin"),t.abrupt("return",this.impl.post(g,p).then((function(e){return e.data})).then((function(t){return String(null==t?void 0:t.code)===l.a.CONSTANTS.CORP_API_SUCCESS_CODE?h.handleLoginResponse(null==t?void 0:t.data):{pass:!1,errmsg:e.getErrMsg(null==t?void 0:t.msgCode),errCode:null==t?void 0:t.msgCode,res:t}})).then(function(){var e=Object(r.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.pass){e.next=3;break}return e.next=3,h.corpLoginSucceed(null==t?void 0:t.res);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()).catch((function(t){return console.log("[login] corp-login with code error:",t),{errmsg:e.commonCatch(t),pass:!1}})));case 9:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.doLoginWithCode=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,s=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.actions.preLoginPassed||!this.actions.currentPreloginRequest){e.next=11;break}if(r=this.actions.currentPreloginRequest,this.actions.loginMethod="code",!(this.actions.codeRetryTime>3)){e.next=5;break}return e.abrupt("return",Promise.resolve({errmsg:u.a["ERR.MOBILEAUTH.RETRYFAILED"],pass:!1}));case 5:if(!g.a.getIsCorpMailMode(this.actions.mailMode)){e.next=7;break}return e.abrupt("return",this.doCorpLoginWithCode(t));case 7:return e.next=9,this.loginWithCode({p:r.p,domain:r.domain,account_name:r.account_name,pass_2fa:n||0,code:t,output:"json"});case 9:return i=e.sent,e.abrupt("return",this.processLoginResult(i).then((function(e){if(null==e?void 0:e.pass){var t=s.actions.currentPreloginRequest,n=(null==t?void 0:t.account_name)+"@"+(null==t?void 0:t.domain);s.tryReportLoginSuccess(n)}return e})));case 11:return e.abrupt("return",Promise.resolve({errmsg:u.a["ERR.ILLEGAL"],pass:!1}));case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetPasswordRules=function(){var t=Object(r.a)(o.a.mark((function t(){var n,r,i,s,a;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,n=this.systemApi.getCurrentUser(),r=this.systemApi.getIsAddAccountPage(),!n||!n.id||this.actions.preLoginPassed&&this.actions.currentPreloginResponse){t.next=6;break}return t.next=6,this.doPreLogin(n.id);case 6:return i=n&&!r?"getPwdRuleAfterLogin":"getPwdRule",t.next=9,this.impl.post(this.getUrl(i),{output:"json"},{headers:{"Qiye-Header":"anticsrf"}});case 9:if(s=t.sent,!(a=this.unpackLoginData(s))||!a.code||"200"!==String(a.code)){t.next=17;break}if(!a.result){t.next=14;break}return t.abrupt("return",{pwdrule:a.result,nickname:(null==n?void 0:n.nickName)||"",sign:""});case 14:if(!a.data){t.next=16;break}return t.abrupt("return",a.data);case 16:return t.abrupt("return",{});case 17:return t.abrupt("return",{errmsg:e.getErrMsg(a.msgCode)});case 20:return t.prev=20,t.t0=t.catch(0),console.warn("[login] getPwdRul error:",t.t0),t.abrupt("return",{errmsg:e.commonCatch(t.t0)});case 24:case"end":return t.stop()}}),t,this,[[0,20]])})));return function(){return t.apply(this,arguments)}}(),t.doCheckPasswordMatch=function(){var t=Object(r.a)(o.a.mark((function t(n,r){var i,s,a,c;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r&&this.storeCurrentAccount({account:r}),i=this.systemApi.getCurrentUser()){t.next=4;break}return t.abrupt("return",!1);case 4:return t.next=6,this.getS({originPwd:e.accountPwdAutoFilled,originAccount:r||i.id,md5Encrypt:!0});case 6:if(s=t.sent,a=s.pwd,"plain"===(c=s.type)||"md5"===c){t.next=11;break}return t.abrupt("return",!1);case 11:return t.abrupt("return",!(!n||!a||a===e.accountPwdAutoFilled||a!==n&&a!==this.systemApi.md5(n)));case 12:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.doUpdatePassword=function(){var t=Object(r.a)(o.a.mark((function t(n,r,i){var s,a,c,u,d,p,g,l,h,f,m,b;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,s=this.systemApi.getCurrentUser(),a=this.systemApi.getIsAddAccountPage(),u=(c=s&&!a)?"updatePwdAfterLogin":"updatePwd",d={password:n,old_pass:i,passType:0,passchange_req:0},p={output:"json",pass:n,sign:r},g=c?d:p,t.next=10,this.impl.post(this.getUrl(u),g,{headers:{"Qiye-Header":"anticsrf"}});case 10:if(l=t.sent,h=this.unpackLoginData(l),"200"!==String(h.code)){t.next=22;break}if(this.storePwd(n),"updatePwd"!==u){t.next=21;break}return t.next=17,this.processLoginResult(h);case 17:return(null==(f=t.sent)?void 0:f.pass)&&(m=this.actions.currentPreloginRequest,b=(null==m?void 0:m.account_name)+"@"+(null==m?void 0:m.domain),this.tryReportLoginSuccess(b)),f&&(f.redirectUrl="entry"),t.abrupt("return",f);case 21:return t.abrupt("return",{pass:!0,errmsg:""});case 22:return t.abrupt("return",{errmsg:null==h?void 0:h.message,pass:!1});case 25:return t.prev=25,t.t0=t.catch(0),console.warn("[login] getPwdRul error:",t.t0),t.abrupt("return",Promise.resolve({errmsg:e.commonCatch(t.t0),pass:!1}));case 29:case"end":return t.stop()}}),t,this,[[0,25]])})));return function(){return t.apply(this,arguments)}}(),t.processLoginResult=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,s=e.processLogin(n),i=this.handleLoginResponse(s),t.next=5,this.loginDoorEnter(i);case 5:r=t.sent,t.next=12;break;case 8:t.prev=8,t.t0=t.catch(0),console.log("[login] login error:",t.t0),r=t.t0&&"string"==typeof t.t0&&"NETWORK.ERR.TIMEOUT"===t.t0?{pass:!1,timeout:!0,errmsg:"请求超时"}:{errmsg:e.commonCatch(t.t0),pass:!1};case 12:return t.prev=12,(null==i?void 0:i.pass)&&!(null==r?void 0:r.pass)&&this.clearCookies(!1),r&&"code"!==this.actions.loginMethod&&(c=(a=r).secondCheck,u=a.showResetPass,c||u||(this.actions.preLoginPassed=!1)),t.finish(12);case 16:return t.abrupt("return",r);case 17:case"end":return t.stop()}}),t,this,[[0,8,12,16]])})));return function(){return t.apply(this,arguments)}}(),t.setPreLoginPassed=function(e){this.actions&&(this.actions.preLoginPassed=e)},t.doLogout=function(){var e=Object(r.a)(o.a.mark((function e(t,n,r){var i,s,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.systemApi.isTransferringData()&&!this.systemApi.isBkLoginInit()){e.next=2;break}return e.abrupt("return",Promise.reject(new Error("not proper time to logout")));case 2:if(e.prev=2,console.trace("logout and clear cookie:",t,n),this.dataTrackApi.track("pc_logout_occurred",{notDeleteAccount:t,clearCookies:n}),i=this.systemApi.getCurrentUser()){e.next=8;break}return e.abrupt("return","");case 8:if(this.impl.setLogoutStatus(!0),t){e.next=12;break}return e.next=12,this.accountApi.doDeleteAccountList([i.id]);case 12:return this.disableBackgroundDB(!0),e.next=15,this.sendLoginEvent(void 0);case 15:return s=e.sent,e.next=18,this.storeApi.setLastAccount(void 0);case 18:return a=this.systemApi.getIsCorpMailMode(),e.next=21,this.clearCookies(a);case 21:return e.abrupt("return",s);case 24:return e.prev=24,e.t0=e.catch(2),console.error("[login] logout error ",e.t0),e.abrupt("return","SERVER.ERR");case 28:return e.prev=28,this.storeApi.setCurrentNode(void 0),r||(this.actions=new C),e.finish(28);case 32:case"end":return e.stop()}}),e,this,[[2,24,28,32]])})));return function(){return e.apply(this,arguments)}}(),t.getLoginAccountInfo=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c,u,d;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.handleAccountAndDomain(t),a=this.systemApi.getUrl("loginGetAccount"),e.next=4,this.impl.get(a,{domain:s.domain,account_name:s.account,output:"json",p:v}).then((function(e){return e.data}));case 4:if(c=e.sent,u="200"===(null===(n=null==c?void 0:c.code)||void 0===n?void 0:n.toString()),d=null===(r=null==c?void 0:c.result)||void 0===r?void 0:r.data,!u||!d){e.next=9;break}return e.abrupt("return",{success:!0,data:{email:d.email,orgName:d.orgName,nickname:d.nickName,cookieName:""}});case 9:return e.abrupt("return",{success:!1,error:{errorCode:(null===(i=null==c?void 0:c.code)||void 0===i?void 0:i.toString())||"",errorMsg:""}});case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doTryNewLoginWithCurrentState=function(){var t=Object(r.a)(o.a.mark((function t(n,r,i){var s,a,c,u,d;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.getLoginAccountInfo(n);case 3:if(c=t.sent,u=c.data,c.success&&u){t.next=7;break}return t.abrupt("return",{pass:!1,errmsg:(null===(s=c.error)||void 0===s?void 0:s.errorMsg)||"认证异常，请登录后重试",errCode:null===(a=c.error)||void 0===a?void 0:a.errorCode});case 7:return this.actions.currentAccount={a:u.email,k:e.accountPwdAutoFilled,lastLogin:Date.now()},d=i&&i.includes("@")?i:"",t.next=11,this.loginSucceed({uid:u.email,nickname:u.nickname,cookieName:r,orgName:u.orgName,cnName:u.cookieName,accessToken:"",accessSecret:"",isCorpMail:!1,nonce:"",mobile:"",isSharedAccountSwitch:!!d,originAccountEmail:d});case 11:return t.abrupt("return",{pass:!0,errmsg:""});case 14:return t.prev=14,t.t0=t.catch(0),console.error("doTryNewLoginWithCurrentState error",t.t0),t.abrupt("return",{pass:!1,errmsg:"认证异常，请登录后重试"});case 18:case"end":return t.stop()}}),t,this,[[0,14]])})));return function(){return t.apply(this,arguments)}}(),t.doTryLoginWithCurrentState=function(){var t=Object(r.a)(o.a.mark((function t(n,r,i){var s,a,c,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!("undefined"!=typeof window&&window.loginUserNewAccountInfo)){t.next=4;break}return t.abrupt("return",this.doTryNewLoginWithCurrentState(n,r,i));case 4:return t.next=6,this.accountApi.getCurrentAccountInfo(n);case 6:return a=t.sent,t.next=9,this.setupNodeInfo(a.node);case 9:return this.actions.currentAccount={a:a.email,k:e.accountPwdAutoFilled,lastLogin:Date.now()},c="",a.unitPathList&&a.unitPathList.length>0&&(c=(null===(s=a.unitPathList[0])||void 0===s?void 0:s.unitName)||""),u=i&&i.includes("@")?i:"",t.next=15,this.loginSucceed({uid:a.email,nickname:a.nickName,cookieName:r,orgName:c,cnName:"",accessToken:"",accessSecret:"",isCorpMail:!1,nonce:"",mobile:"",isSharedAccountSwitch:!!u,originAccountEmail:u});case 15:return t.abrupt("return",{pass:!0,errmsg:""});case 18:return t.prev=18,t.t0=t.catch(0),console.warn("[login] error load user info using cookies ",t.t0),t.abrupt("return",{pass:!1,errmsg:"认证异常，请登录后重试"});case 22:case"end":return t.stop()}}),t,this,[[0,18]])})));return function(){return t.apply(this,arguments)}}(),t.sendSubAccountExpiredEvent=function(){if(this.getIsAccountBg()){var e=this.systemApi;this.eventApi.sendSysEvent({eventName:"SubAccountLoginPreExpired",toType:["main"],eventData:{mainAccount:e.getMainAccount().email,subAccount:e.getCurrentSubAccount().email,agentEmail:e.getCurrentAgentAccount().email}})}},t.getIsAccountBg=function(){return!!Object(c.l)()&&window.isAccountBg},t.watchLogout=function(e){if(this.systemApi.isBkStableWindow())this.systemApi.closeWindow(!1,!0);else if(this.getIsAccountBg())this.sendSubAccountExpiredEvent();else if(e&&Object(p.e)(window.location,c.k)&&!f.a.testPathMatch("/jump/")){var t=(null==e?void 0:e.eventData)||{};this.logoutAndJump(Object.assign({jumpTo:"setting"},t))}},t.logoutAndJump=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,u,d,p,g,l=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(n=t||{}).clearCookies,i=void 0!==r&&r,s=n.notDeleteAccount,a=void 0===s||s,u=n.jumpTo,d=void 0===u?"setting":u,console.trace("[login] logout called:",t),!this.systemApi.isBkLoginInit()){e.next=4;break}return e.abrupt("return");case 4:if(p=this.getIsAccountBg(),!("setting"===d&&this.systemApi.isMainPage()&&this.systemApi.isElectron()&&window.electronLib)||p){e.next=9;break}return(g=function(e){Object(c.p)(t),setTimeout((function(){console.warn("[login] logout navigate called:",t,e),f.a.testHrefMatch(c.s)||(e>0?g(e-1):Object(c.p)())}),2e3)})(3),e.abrupt("return");case 9:this.showAccountLogoutTip(),this.doLogout(!!p||a,!!p||i).then((function(){l.jumpLogin()})).catch((function(e){console.error("logout occurred:",e),l.dataTrackApi.track("auto_logout_exception_occured",{msg:null==e?void 0:e.message}),l.jumpLogin()}));case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.showAccountLogoutTip=function(){0},t.jumpLogin=function(){var e=Object(r.a)(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.noLoginStatus=!0,e.next=3,this.performanceApi.saveLog();case 3:if("login"!==(null==t?void 0:t.jumpTo)){e.next=8;break}return this.logoutProcessing=!0,e.next=7,this.doLogout(t.notDeleteAccount,t.clearCookies);case 7:this.logoutProcessing=!1;case 8:Object(c.p)(t,(function(){console.warn("[login] handle jump login finish and set flag"),n.logoutProcessing=!0}));case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.onPathChange=function(){return this.name},t.reportLogoutToUser=function(e){this.doLogout(!!(null==e?void 0:e.notDeleteAccount),!!(null==e?void 0:e.clearCookies)).then()},t.refreshStatus=function(){this.actions.preLoginPassed=!1},t.autoLoginSharedAccount=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var i=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Object(r.a)(o.a.mark((function e(s){var a,c,u,d,p,g,l,h,f,m,b;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.accountApi.doGetAllAccountList();case 3:return a=e.sent,c=a[0],u=a[1],d=(c||[]).filter((function(e){return e.id===t})),p=i.storeApi.getUUID(),g="memory-"+(new Date).getTime().toString(),e.next=11,i.systemApi.createWindowWithInitData({type:"bkLogin",additionalParams:{bkLoginInit:"true",sessionName:g},manualShow:!0,sessionName:g},{eventName:"initBkLoginPage",eventData:{account:d,accountInfo:u,browserUUId:p,accountId:t,isSharedAccountSwitch:!0,targetSharedAccount:n}});case 11:l=e.sent,h=l.winId,f=!1,m=setTimeout((function(){f=!0,s({pass:!1,errMsg:"重登陆超时"})}),3e4),"bkStableSwitchAccount",b=i.eventApi.registerSysEventObserver("bkStableSwitchAccount",{name:"hanldSharedAccountLoginExpired-result",func:function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,a,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!f){e.next=2;break}return e.abrupt("return");case 2:if(m&&window.clearTimeout(m),h&&i.systemApi.closeSubWindow(h,!1,!0),b&&i.eventApi.unregisterSysEventObserver("bkStableSwitchAccount",b),n=t.eventData,r=n.currentUser,a=n.pass,c=n.account,!a){e.next=23;break}if(!r){e.next=17;break}if(!(u=i.systemApi.getCurrentUser())){e.next=17;break}if(i.storeApi.setLastAccount(u),!u.cookies||!u.cookies.length){e.next=17;break}return e.next=15,window.electronLib.appManage.clearCookieStore();case 15:return e.next=17,window.electronLib.appManage.setCookieStore(u.cookies);case 17:if(!c||!c.length){e.next=20;break}return e.next=20,i.accountApi.storeAccountList(c);case 20:s({pass:!0}),e.next=24;break;case 23:return e.abrupt("return",s({pass:!1}));case 24:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(0),s({pass:!1,errMsg:e.t0.message});case 22:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.watchLoginExpired=function(e){var t=this;if(console.log("got re-login ev:",e),this.systemApi.isElectron()&&window.electronLib&&!this.systemApi.isBkLoginInit()&&!window.isAccountBg&&"loginExpired"===e.eventName&&this.eventApi.sendSimpleSysEvent("loginExpiredCrossWindow"),this.actions.logout||this.systemApi.isTransferringData())console.log("[login] will not handle re-login ev:",e);else{var n=this.getIsAccountBg();if(this.actions.autoLogin)console.warn("[login] re-login processing",e);else if(this.actions.autoLogin=!0,console.warn("[login] handle re-login ev:",e),(this.systemApi.isMainPage()||n)&&this.systemApi.isElectron()||!this.systemApi.isElectron()){var r=this.systemApi.getCurrentUser();if(r&&r.isSharedAccount&&r.originAccount)return void this.autoLoginSharedAccount(r.originAccount.email,r.id).then((function(e){if(e.pass){var n=t.systemApi.getCurrentUser();n&&t.sendLoginEvent(n,!1)}else t.trackReLoginFailedToHubble("sharedAccount autoLogin error "+(e.errMsg||"")),t.triggerLogoutLogical(!1)})).finally((function(){t.actions.autoLogin=!1}));this.autoLogin().then((function(r){if(r.pass)console.log("[login] re-login success",e,r);else{if(r.timeout){var i=t.systemApi.getCurrentUser();if(i)return void t.sendLoginEvent(i,!0).then()}t.trackReLoginFailedToHubble("autoLogin error "+(r.errmsg||"")),t.triggerLogoutLogical(n)}})).catch((function(e){console.warn("[login] re-login failed with exception :",e),t.trackReLoginFailedToHubble("autoLogin catch error "+(e.message||"")),t.triggerLogoutLogical(n)})).finally((function(){t.actions.autoLogin=!1}))}}},t.trackReLoginFailedToHubble=function(e){try{var t=Object(p.c)(),n=Object(p.b)();this.dataTrackApi.track("pc_login_re_login_failed",{msg:e,uptime:t,env:n,subType:"reloginfailed"})}catch(r){console.error("trackReLoginFailedToHubble ex",r)}},t.trackLogoutToHubble=function(){try{var e=Object(p.c)();this.dataTrackApi.track("pc_login_logout_occurred",{uptime:e,subType:"reloginfailed"})}catch(t){console.error("trackLogoutToHubble login error",t)}},t.triggerLogoutLogical=function(e){this.trackLogoutToHubble(),e?this.sendSubAccountExpiredEvent():(this.systemApi.unLockApp(),this.logoutAndJump({clearCookies:!0,notDeleteAccount:!0,jumpTo:"setting"}))},t.init=function(){var t,n=this,i=this.systemApi.getIsAddSubAccountPage(),s=this.systemApi.getIsAddPersonalSubAccountPage();Object(c.l)()&&(this.loadUUID(),this.systemApi.isMainPage()&&!e.isInited&&this.eventApi.registerSysEventObserver("loginExpiredCrossWindow",{name:"loginWatchLoginExpiredCross",func:this.watchLoginExpired.bind(this)}),i&&(this.registerAddSubAccountInitEvent(),this.registerSubAccountPageSendMobileCodeEvent(),this.registerSubAccountLoginWithCodeEvent()),this.systemApi.getIsSubAccountInitPage()&&this.registerSubAccountInitEvent(),s&&this.registerAddPersonalSubAccountInitEvent());return i||s||(!e.isInited&&this.eventApi.registerSysEventObserver("loginExpired",{name:"loginWatchLoginExpired",func:this.watchLoginExpired.bind(this)}),!e.isInited&&this.eventApi.registerSysEventObserver("logout",{name:"loginWatchLogout",func:this.watchLogout.bind(this)}),!e.isInited&&this.eventApi.registerSysEventObserver("loginBlock",{name:"loginNoLoginStatusOb",func:function(e){e&&void 0!==e.eventData&&(n.noLoginStatus="true"===String(e.eventData))}}),!e.isInited&&this.eventApi.registerSysEventObserver("loginRetry",{name:"loginWatchRetryOb",func:(t=Object(r.a)(o.a.mark((function e(){var t,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!(t=n.systemApi.getCurrentUser())||!t.id){e.next=8;break}return e.next=5,n.accountApi.getCurrentAccountInfo(null==t?void 0:t.id);case 5:(r=e.sent).email&&n.impl.afterLogin&&n.impl.afterLogin({event:"afterLogin",data:{eventName:"login",eventData:t,eventSeq:0,eventStrData:"timeout_event"}}),console.warn("[login] login retry succeed",r);case 8:e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("[login] login retry failed",e.t0),n.triggerLogoutLogical(n.getIsAccountBg());case 14:case"end":return e.stop()}}),e,null,[[0,10]])}))),function(){return t.apply(this,arguments)})}),!e.isInited&&this.systemApi.intervalEvent({eventPeriod:"mid",seq:0,id:"login_watch_dog",noUserAuth:!0,handler:function(e){e.seq>7&&e.seq%3==0&&(n.noLoginStatus||n.handleNoCurrentUser())}}),e.isInited=!0),this.name},t.handleNoCurrentUser=function(){var e=this;null==this.systemApi.getCurrentUser()&&setTimeout((function(){null!=e.systemApi.getCurrentUser()||e.noLoginStatus||e.notifyNoLogin()}),7700)},t.notifyNoLogin=function(){var e=this;Object(p.e)(window.location,c.k)&&(this.actions.loginIssueConfirmShowed?(this.actions.loginIssueConfirmShowed=!0,this.eventApi.sendSysEvent({eventName:"error",eventLevel:"error",eventStrData:"",eventData:{popupType:"window",popupLevel:"error",title:"登录状态异常",content:"将跳转至账号管理页，跳转后可尝试重新登录",code:"PARAM.ERR",auto:!1,btnConfirmTxt:"立即跳转",confirmCallback:function(){e.systemApi.isMainPage()?(e.actions.loginIssueConfirmShowed=!1,e.jumpLogin({jumpTo:"setting",clearCookies:!1,notDeleteAccount:!0})):window.electronLib&&e.systemApi.isElectron()&&e.systemApi.closeWindow(!0)},cancelCallback:function(){e.actions.loginIssueConfirmShowed=!1,console.warn("user cancel the dialog of login alert"),e.dataTrackApi.track("pc_logout_alerted_and_canceled_by_user",{location:window.location.href})}},eventSeq:0})):this.eventApi.sendSysEvent({eventName:"error",eventLevel:"error",eventStrData:"",eventData:{popupType:"toast",popupLevel:"error",title:"登录状态异常",content:"请确认是否请求出现异常",code:"PARAM.ERR",auto:!1},eventSeq:0})),this.systemApi.isBkStableWindow()&&this.systemApi.closeWindow(!1,!0)},t.afterInit=function(){return this.autoFillPwdMd5=this.systemApi.md5(e.accountPwdAutoFilled,!0),this.name},t.sendAccountInitModuleEvent=function(){this.eventApi.sendSysEvent({eventName:"initModule",eventStrData:"account"})},t.afterLoadFinish=function(){var e=this;return this.loadStorageToDB().then((function(t){var n=e.systemApi.getIsCorpMailMode();t&&!n&&e.bindAccountDevice().then();var r=e.systemApi.getCurrentUser();if(null==r?void 0:r.id)return e.getAccountStored(r.id)})).then((function(t){if(t&&e.storeCurrentAccount({account:t.id,pwd:t.pwd,mobile:t.mobile,refreshToken:t.refreshToken,refreshTokenExpire:t.refreshTokenExpire}),"prod"!==c.c&&console.log("[login] current account:",t),e.systemApi.isElectron()&&window.electronLib&&(null==t?void 0:t.id)&&!(null==t?void 0:t.cookies))try{var n=e.systemApi.getCurrentSessionName(),r=n?{sessionName:n}:void 0;window.electronLib.appManage.getCookieStore(r).then((function(n){e.accountApi.doUpdateAccountList([{id:null==t?void 0:t.id,cookies:n}])}))}catch(i){console.warn(i)}})).catch((function(e){console.error(e)})).finally((function(){e.sendAccountInitModuleEvent(),e.logoutProcessing=!1})),this.name},t.setDeviceId=function(){var e=Object(r.a)(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return A.deviceid=t,e.abrupt("return",this.storeUUID(t).then((function(){return n.storeApi.loadUUID()})).then((function(){return n.impl.updateDeviceInfo()})).catch((function(e){console.error("setDeviceId error",e)})));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.storeUUID=function(t){return this.storeApi.put(e.keyDeviceUUID,t,e.storeConfig)},t.loadUUID=function(){var t=this;this.storeApi.get(e.keyDeviceUUID,e.storeConfig).then((function(e){if(e.suc&&e.data)A.deviceid=e.data;else{var n="i-"+(new Date).getTime().toString(16)+"-"+t.systemApi.generateKey(16);t.storeUUID(n).then((function(){A.deviceid=n}))}}))},t.bindAccountDevice=function(){var e=Object(r.a)(o.a.mark((function e(){var t,n,r,i,s,a,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.systemApi.getCurrentUser(),e.next=3,this.systemApi.getDeviceInfo();case 3:if(n=e.sent,t&&n._deviceId&&this.systemApi.isElectron()){e.next=6;break}return e.abrupt("return");case 6:if(e.prev=6,!(r=this.getIsAccountBg())){e.next=10;break}return e.abrupt("return");case 10:return e.next=12,this.accountApi.doGetAllMainAndSubAccounts();case 12:return i=e.sent,s=r?this.systemApi.getMainAccount().email:t.id,a=i.map((function(e){return{bizAccountId:e.id,bindType:"EMAIL",loginStatus:s===e.id?1:0}})),e.next=17,this.impl.post(this.getUrl("bindAccountDevice"),{bindAccountList:a},{contentType:"json"});case 17:c=e.sent,(u=c.data)&&u.success?console.log("[login] bindAccountDevice Success! bindAccountList",a):console.error("[login] bindAccountDeviceError",null==u?void 0:u.message),e.next=25;break;case 22:e.prev=22,e.t0=e.catch(6),console.error("[login] +bindAccountDeviceError",e.t0);case 25:case"end":return e.stop()}}),e,this,[[6,22]])})));return function(){return e.apply(this,arguments)}}(),t.requestReportSuccApi=function(e){return this.impl.post(this.systemApi.getUrl("notifyLoginSuc"),{account:e})},t.getVerifyCodeUrl=function(e,t,n){var r=this.getUrl("corpMailGetVerifyCode");return l.a.getNewImgVerifyCodeUrl({baseUrl:r,accountName:e,accountDomain:t,sid:n})},t.registerAddAccountPageReturnEvent=function(){var e=Object(r.a)(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.addAccountEventId){e.next=2;break}return e.abrupt("return");case 2:this.addAccountEventId=this.eventApi.registerSysEventObserver("addAccountPageReturnEvent",function(){var e=Object(r.a)(o.a.mark((function e(n){var i,s,a,c,u,d,g,l;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=n.eventData)){e.next=35;break}return t.disableBackgroundDB(),s=i.currentUser,a=i.currentNode,c=i.originAccount,u=i.originAccountInfo,d=i.authInfo,t.systemApi.switchLoading(!0),e.next=7,t.eventApi.sendSysEvent({eventName:"loginBlock",eventData:!0,eventSeq:0});case 7:return e.next=9,Object(p.i)(10);case 9:if(t.impl.setLogoutStatus(!0),s&&t.storeApi.setLastAccount(s),a&&t.storeApi.setCurrentNode(a),c&&c.length&&t.accountApi.doUpdateAccountList(c),u&&u.length&&t.accountApi.storeAccountInfoList(u),d&&t.productAuthApi.setStoreAuthInfo(d),!(window&&window.electronLib&&s)){e.next=35;break}return t.systemApi.switchLoading(!0),g=window,l=g.electronLib,e.next=20,l.windowManage.show();case 20:return e.next=22,l.appManage.clearCookieStore();case 22:return e.next=24,l.appManage.setCookieStore(s.cookies);case 24:return e.next=26,l.windowManage.closeAllWindowExceptMain(!0);case 26:return e.prev=26,e.next=29,l.masterBridgeManage.flush("");case 29:e.next=34;break;case 31:e.prev=31,e.t0=e.catch(26),console.error("masterBridgeManage.flush error",e.t0);case 34:setTimeout(Object(r.a)(o.a.mark((function e(){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.createBKStableWindow();case 2:return e.next=4,l.windowManage.getCurWindow();case 4:if(!(n=e.sent)){e.next=8;break}return e.next=8,l.windowManage.reload(n.id);case 8:case"end":return e.stop()}}),e)}))),200);case 35:case"end":return e.stop()}}),e,null,[[26,31]])})));return function(){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.showCreateAccountPage=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s,a,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(window){e.next=2;break}return e.abrupt("return");case 2:return n=this.systemApi.getCurrentHostType(),r=this.systemApi.getCurrentUser(),i=this.storeApi.getUUID(),s="memory-"+(new Date).getTime().toString(),this.registerAddAccountPageReturnEvent(),e.next=9,this.getAllWindowsByVisible(!0,["addAccount"]);case 9:return a=e.sent,this.toggleAllWindows(a,!1),e.next=13,window.electronLib.windowManage.getWinBounds();case 13:c=e.sent,this.systemApi.createWindowWithInitData({type:"addAccount",additionalParams:Object.assign({"add-account-page":"true","lang-str":window.systemLang},t?{"login-email":t}:{}),sessionName:s,bounds:c},{eventName:"initAddAccountPageEvent",eventData:{currentHostType:n,currentUser:r,browserUUId:i,sessionName:s,visibileWinIds:a}});case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getAllWindowsByVisible=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=[]),window&&window.electronLib){e.next=3;break}return e.abrupt("return",[]);case 3:return r=window.electronLib.windowManage,e.next=6,r.getAllWinInfo();case 6:return i=e.sent,s=[],i.forEach((function(e){var r=e.id;e.isVisible!==t||s.includes(r)||(!(!n||!n.length)&&n.includes(e.type)||s.push(r))})),e.abrupt("return",s);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.toggleAllWindows=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.length){e.next=2;break}return e.abrupt("return");case 2:if(window&&window.electronLib){e.next=4;break}return e.abrupt("return");case 4:r=window.electronLib.windowManage,t.forEach((function(e){n?r.show(e):r.hide(e)}));case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.getCommonBindWinData=function(){return{currentHostType:this.systemApi.getCurrentHostType(),browserUUId:this.storeApi.getUUID(),sessionName:"memory-"+(new Date).getTime().toString()}},t.registerSubAccountPageReturnEvent=function(e){var t=this,n=this.eventApi.registerSysEventObserver("addSubAccountPageReturnEvent",(function(r){var i;if(r&&r.eventData){var o=r.eventData;(o.success||"600"!==(null===(i=o.errCode)||void 0===i?void 0:i.toString()))&&t.eventApi.unregisterSysEventObserver("addSubAccountPageReturnEvent",n),r&&r.eventData&&e(r.eventData)}}))},t.registerAddPersonalSubAccountInitEvent=function(){var e=this;this.eventApi.registerSysEventObserver("initAddPersonalSubAccountPageEvent",function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u,d,p,g,l,h;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n&&n.eventData){t.next=2;break}return t.abrupt("return");case 2:if(e.disableBackgroundDB(),r=e.systemApi,i=n.eventData,s=i.sessionName,a=i.browserUUId,c=i.currentHostType,u=i.bindInfo,d=i.cookies,(p=i.currentNode)&&e.setupNodeInfo(p,!0),c&&r.setCurrentHostType(c),!s){t.next=12;break}if(r.setCurrentSessionName(s),!d||!d.length){t.next=12;break}return t.next=12,window.electronLib.appManage.setCookieStore(d,s);case 12:return a&&e.setDeviceId(a),g=u.agentEmail,t.next=16,e.loginAgentEmail(g);case 16:if((l=t.sent).success){t.next=21;break}e.sendAddSubAccountResultEvent(l),t.next=25;break;case 21:return t.next=23,e.getAddSubAccountPageReturnData();case 23:h=t.sent,e.sendAddSubAccountResultEvent(h);case 25:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}())},t.createSubAccountWindow=function(e){var t=e.sessionName,n=e.param,r=t||"memory-"+(new Date).getTime();e.sessionName=r;var i=Object.assign({sessionName:r},n||{});return e.param=i,this.accountApi.createSubAccountWin(e)},t.sendSubAccountAddedEvent=function(e){this.eventApi.sendSysEvent({eventName:"SubAccountAdded",eventData:e})},t.handleAddSubAccountSuccess=function(){var e=Object(r.a)(o.a.mark((function e(t,n,r){var i,s,a,c,u,d,p,g,l,h;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.systemApi.getCurrentUser(),t&&i){e.next=4;break}return n({success:!1,errMsg:m.a,errCode:100}),e.abrupt("return");case 4:if(t.success){e.next=7;break}return n({success:!1,errCode:t.errCode,errMsg:t.errMsg}),e.abrupt("return");case 7:if(s=t.currentUser,a=t.currentNode,c=t.originAccount,u=t.authInfo,s){e.next=11;break}return n({success:!1,errMsg:"登录绑定账号失败",errCode:201}),e.abrupt("return");case 11:if((d="string"==typeof r?r:r.accountType)!==m.d.NETEASE_QIYE_MAIL){e.next=21;break}if("object"==typeof r&&r.isEditMode){e.next=21;break}return e.next=17,this.addQiyeMailSubAccount(s.id);case 17:if((p=e.sent).success){e.next=21;break}return n(p),e.abrupt("return");case 21:if(g="string"==typeof r?s.id:r.agentEmail,!c||!c.length){e.next=26;break}return c.forEach((function(e){e.mainAccount=i.id;var t=d===m.d.NETEASE_QIYE_MAIL?"qyEmail":"personalEmail";e.accountType=t,e.mainSendReceiveInfo="string"==typeof r?{}:r,e.agentEmail=g,e.expired=!1})),e.next=26,this.accountApi.addOrUpdateLocalSubAccounts(c);case 26:if(!this.actions.bindSubAccountInfo||!this.actions.bindSubAccountInfo.winId){e.next=30;break}return l=this.actions.bindSubAccountInfo.winId,e.next=30,window.electronLib.windowManage.close({winId:l});case 30:return h={mainAccount:i.id,subAccount:s.id,agentEmail:g},this.sendSubAccountAddedEvent(h),this.bindAccountDevice(),e.next=35,this.accountApi.createSubAccountWin({mainAccountEmail:i.id,subAccountEmail:s.id,agentEmail:g,param:{"init-sub-account":"true"},eventName:"initSubAccountBgPageEvent",eventData:{currentNode:a,authInfo:u,currentUser:s}});case 35:n({success:!0});case 36:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getAddSubAccountWinCommonInfo=function(){return{mainAccountEmail:"",agentEmail:"",subAccountEmail:""}},t.addSubBindInfoToActions=function(e,t,n){this.actions.bindSubAccountInfo={winId:e,webId:t,sessionName:n}},t.bindSubAccountMail=function(e){var t=this;return new Promise(function(){var n=Object(r.a)(o.a.mark((function n(i){var s,a,c,u,d,p,g,l,h,f;return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,e&&(e.agentEmail&&(e.agentEmail=e.agentEmail.trim()),e.password&&(e.password=e.password.trim())),t.systemApi.getCurrentUser()){n.next=6;break}return i({success:!1,errMsg:"获取主账号失败",errCode:300}),n.abrupt("return");case 6:if(s=t.getCommonBindWinData(),a=s.currentHostType,c=s.browserUUId,u=s.sessionName,d=Object.assign(Object.assign({},t.getAddSubAccountWinCommonInfo()),{sessionName:u}),"NeteaseQiYeMail"===e.accountType){n.next=32;break}if(!e.isEditMode){n.next=13;break}n.t0={success:!0},n.next=16;break;case 13:return n.next=15,t.addPersonalMailSubAccount(e);case 15:n.t0=n.sent;case 16:if((p=n.t0).success){n.next=20;break}return i(p),n.abrupt("return");case 20:return n.next=22,window.electronLib.appManage.getCookieStore();case 22:return g=n.sent,t.registerSubAccountPageReturnEvent(function(){var n=Object(r.a)(o.a.mark((function n(r){return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:t.handleAddSubAccountSuccess(r,i,e);case 1:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}()),l=t.storeApi.getCurrentNode(),n.next=27,t.createSubAccountWindow(Object.assign(Object.assign({},d),{param:{"add-personal-sub-account":"true"},eventName:"initAddPersonalSubAccountPageEvent",eventData:{cookies:g,bindInfo:{agentEmail:e.agentEmail},currentNode:l,currentHostType:a,browserUUId:c}}));case 27:if(h=n.sent){n.next=30;break}return n.abrupt("return");case 30:return t.addSubBindInfoToActions(h.winId,h.webId,u),n.abrupt("return");case 32:return t.registerSubAccountPageReturnEvent(function(){var n=Object(r.a)(o.a.mark((function n(r){return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:t.handleAddSubAccountSuccess(r,i,e);case 1:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}()),n.next=35,t.createSubAccountWindow(Object.assign(Object.assign({},d),{eventName:"initAddSubAccountPageEvent",param:{"add-sub-account":"true"},eventData:{currentHostType:a,browserUUId:c,bindInfo:e}}));case 35:if(f=n.sent){n.next=38;break}return n.abrupt("return");case 38:t.addSubBindInfoToActions(f.winId,f.webId,u),n.next=44;break;case 41:n.prev=41,n.t1=n.catch(0),i({success:!1,errMsg:m.a,errCode:101});case 44:case"end":return n.stop()}}),n,null,[[0,41]])})));return function(){return n.apply(this,arguments)}}())},t.sendAddSubAccountResultEvent=function(e){this.eventApi.sendSysEvent({eventName:"addSubAccountPageReturnEvent",toType:["main"],eventData:e})},t.getAddSubAccountPageReturnData=function(){var e=Object(r.a)(o.a.mark((function e(){var t,n,r,i,s,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.systemApi.getCurrentUser(),n=this.storeApi.getCurrentNode(),r=this.productAuthApi.getStoreAuthInfo(),e.next=5,this.accountApi.doGetAllAccountList();case 5:return i=e.sent,s=i[0],a=i[1],e.abrupt("return",{success:!0,currentUser:t,currentNode:n,authInfo:r,originAccount:s,originAccountInfo:a});case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.registerSubAccountPageSendMobileCodeEvent=function(){var e=Object(r.a)(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.eventApi.registerSysEventObserver("addSubAccountPageSendMobileCode",(function(){t.doSendVerifyCode().then((function(e){t.eventApi.sendSysEvent({eventName:"addSubAccountPageSendMobileCodeReturnEvent",toType:["main"],eventData:{success:!e,errMsg:e,errCode:300}})}))}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.registerSubAccountLoginWithCodeEvent=function(){var e=this;this.eventApi.registerSysEventObserver("addSubAccountPageVerifyMobileCode",(function(t){if(t&&t.eventData){var n=t.eventData,r=n.code,i=n.needPersist,o="addSubAccountPageVerifyMobileCodeReturnEvent";e.doLoginWithCode(r,i).then((function(t){var n={success:t.pass};t.pass?e.getAddSubAccountPageReturnData().then((function(t){n=t,e.eventApi.sendSysEvent({eventName:o,toType:["main"],eventData:n})})):(t.errmsg?n.errMsg=t.errmsg:t.showResetPass&&(n.errMsg="为保障帐户安全，管理员请您修改邮箱密码",n.errCode=700),e.eventApi.sendSysEvent({eventName:o,toType:["main"],eventData:n}))}))}}))},t.bindAccountLoginWithCode=function(){var e=Object(r.a)(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){n.eventApi.sendSysEvent({eventName:"addSubAccountPageVerifyMobileCode",toType:["subAccountBg"],eventData:{code:t,needPersist:1}});var r=n.eventApi.registerSysEventObserver("addSubAccountPageVerifyMobileCodeReturnEvent",(function(t){if(n.eventApi.unregisterSysEventObserver("addSubAccountPageVerifyMobileCodeReturnEvent",r),t&&t.eventData){var i=t.eventData;i.success?n.handleAddSubAccountSuccess(i,e,n.subAccountBindInfo||m.d.NETEASE_QIYE_MAIL):e({success:!1,errCode:i.errCode,errMsg:i.errMsg||m.b})}}))})));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.sendBindAccountVerifyCode=function(){var e=Object(r.a)(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Object(r.a)(o.a.mark((function e(n){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.eventApi.sendSysEvent({eventName:"addSubAccountPageSendMobileCode",toType:["subAccountBg"]}),"addSubAccountPageSendMobileCodeReturnEvent",r=t.eventApi.registerSysEventObserver("addSubAccountPageSendMobileCodeReturnEvent",(function(e){t.eventApi.unregisterSysEventObserver("addSubAccountPageSendMobileCodeReturnEvent",r),e&&e.eventData||n({success:!1,errMsg:"服务错误，请稍后重试",errCode:100});var i=e.eventData;i&&n(i)}));case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.registerSubAccountInitEvent=function(){var e=this,t=this.eventApi.registerSysEventObserver("initSubAccountBgPageEvent",function(){var n=Object(r.a)(o.a.mark((function n(r){var i,s,a,c,u,d,p,g,l;return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.eventApi.unregisterSysEventObserver("initSubAccountBgPageEvent",t),r&&r.eventData){n.next=3;break}return n.abrupt("return");case 3:if(i=e.systemApi,s=r.eventData,a=s.sessionName,c=s.browserUUId,u=s.currentHostType,d=s.currentUser,(p=s.currentNode)&&e.storeApi.setCurrentNode(p),u&&i.setCurrentHostType(u),a&&i.setCurrentSessionName(a),!c){n.next=11;break}return n.next=11,e.setDeviceId(c);case 11:if(!d){n.next=19;break}return e.storeApi.setLastAccount(d),g=window,l=g.electronLib,n.next=16,l.appManage.clearCookieStore(a);case 16:return n.next=18,l.appManage.setCookieStore(d.cookies,a);case 18:setTimeout((function(){window.electronLib.windowManage.reload()}),20);case 19:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}())},t.registerAddSubAccountInitEvent=function(){var e=this;this.eventApi.registerSysEventObserver("initAddSubAccountPageEvent",function(){var t=Object(r.a)(o.a.mark((function t(n){var i,s,a,c,u,d,p;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.disableBackgroundDB(),n&&n.eventData){t.next=3;break}return t.abrupt("return");case 3:if(i=n.eventData,s=i.sessionName,a=i.browserUUId,c=i.currentHostType,u=i.bindInfo,c&&e.systemApi.setCurrentHostType(c),s&&e.systemApi.setCurrentSessionName(s),!a){t.next=9;break}return t.next=9,e.setDeviceId(a);case 9:if(u){t.next=12;break}return e.sendAddSubAccountResultEvent({success:!1,errMsg:"绑定信息为空",errCode:99}),t.abrupt("return");case 12:u.accountType===m.d.NETEASE_QIYE_MAIL&&(d=u.agentEmail,p=u.password,e.doPreLogin(d).then((function(t){if(!t)return!0;var n={success:!1};if("object"==typeof t&&t.err)n.errMsg=t.errmsg;else{if("string"!=typeof t)return!0;n.errMsg=t}return e.sendAddSubAccountResultEvent(n),!1})).then((function(t){t&&e.doLogin({account:d,pwd:p}).then(function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r={success:!1},!n.pass){t.next=7;break}return t.next=4,e.getAddSubAccountPageReturnData();case 4:return i=t.sent,e.sendAddSubAccountResultEvent(i),t.abrupt("return");case 7:n.errmsg?(r.errMsg=n.errmsg,r.errCode=400):n.secondCheck?n.showConfig?(r.errMsg="检测到您需要开启二次登录验证，请去Web端开启",r.errCode=500):(r.errMsg=n.mobile||"***********",r.errCode=600):n.showResetPass&&(r.errMsg="为保障帐户安全，管理员请您修改邮箱密码",r.errCode=700),e.sendAddSubAccountResultEvent(r);case 9:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}())})));case 13:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}())},t.bindSubAccount=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.stopBindAccount();case 2:return this.subAccountBindInfo=t,e.next=5,this.bindSubAccountMail(t);case 5:if((r=e.sent).success||r.errMsg||(r.errMsg=m.b),!r.success&&"600"===(null===(n=r.errCode)||void 0===n?void 0:n.toString())){e.next=10;break}return e.next=10,this.stopBindAccount();case 10:return e.abrupt("return",r);case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.stopBindAccount=function(){var e=Object(r.a)(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.subAccountBindInfo=null,!(t=this.actions).bindSubAccountInfo){e.next=8;break}if(!((n=t.bindSubAccountInfo.winId)&&window&&window.electronLib)){e.next=7;break}return e.next=7,window.electronLib.windowManage.close({winId:n,force:!0,quit:!0});case 7:t.bindSubAccountInfo={};case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.addQiyeMailSubAccount=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.systemApi.getUrl("addQiyeMailSubAccount"),e.next=4,this.impl.post(r,{email:t},Object.assign({},this.getCommonWebConfig())).then((function(e){return e.data}));case 4:if(i=e.sent){e.next=7;break}return e.abrupt("return",{success:!1,errMsg:m.a,errCode:200});case 7:if("200"!==(null===(n=i.code)||void 0===n?void 0:n.toString())){e.next=10;break}return e.abrupt("return",{success:!0});case 10:return"ACCOUNT.LOGINREF.CREATE.OVERFLOW"===(s=null==i?void 0:i.errorCode)&&this.sendAgentAccountLimitToServer(),e.abrupt("return",{success:!1,errMsg:m.c[s]||i.error||m.b,errCode:s});case 15:return e.prev=15,e.t0=e.catch(0),console.error("addQiyeMailSubAccount error",e.t0),e.abrupt("return",{success:!1,errMsg:(null===e.t0||void 0===e.t0?void 0:e.t0.message)||"",errCode:"addQiyeMailSubAccount-catch"});case 19:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),t.getBindAccountErrorMsg=function(e){var t=null==e?void 0:e.errorCode;return t&&(m.c[t]||(null==e?void 0:e.err_msg))||m.a},t.getCommonWebConfig=function(){return{headers:L}},t.addPersonalMailSubAccount=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.systemApi.getUrl("createPersonalSubAccount"),i={agent_email:t.agentEmail,agent_nickname:t.agentNickname,password:t.password,send_host:t.sendHost,send_port:t.sendPort,send_ssl:t.sendSsl,receive_protocol:t.receiveProtocol,receive_host:t.receiveHost,receive_ssl:t.receiveSsl,receive_port:t.receivePort},e.next=5,this.impl.post(r,i,Object.assign({},this.getCommonWebConfig())).then((function(e){return e.data}));case 5:if(s=e.sent,"200"!==(null===(n=null==s?void 0:s.code)||void 0===n?void 0:n.toString())){e.next=8;break}return e.abrupt("return",{success:!0});case 8:return"AGENTACCOUNT.CREATE.BIND.OVERFLOW"===(null==s?void 0:s.errorCode)&&this.sendAgentAccountLimitToServer(),e.abrupt("return",{success:!1,errCode:null==s?void 0:s.errorCode,errMsg:this.getBindAccountErrorMsg(s)});case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",{success:!1,errCode:"addPersonalMailSubAccount-catch",errMsg:e.t0.message});case 15:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),t.loginAgentEmail=function(){var e=Object(r.a)(o.a.mark((function e(t,n,r){var i,s,a,c,u;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=this.systemApi.getUrl("loginAgentEmail"),a=[n?"_session="+n:"",r?"_setsession="+r:""].filter((function(e){return e})),e.next=5,this.impl.post(s+(a&&a.length?"?"+a.join("&"):""),{agent_email:t,p:"sirius-desktop",output:"json"}).then((function(e){return e.data}));case 5:if(c=e.sent,"200"!==(null===(i=null==c?void 0:c.code)||void 0===i?void 0:i.toString())){e.next=11;break}return e.next=9,this.processLoginResult(c);case 9:return u=e.sent,e.abrupt("return",{success:u.pass,errCode:u.errCode,errMsg:u.errmsg});case 11:return e.abrupt("return",{success:!1,errCode:null==c?void 0:c.msgCode,errMsg:null==c?void 0:c.msgCodeDesc});case 14:return e.prev=14,e.t0=e.catch(0),e.abrupt("return",{success:!1,errCode:"loginAgentEmail-catch",errMsg:e.t0.message});case 17:case"end":return e.stop()}}),e,this,[[0,14]])})));return function(){return e.apply(this,arguments)}}(),t.sendAgentAccountLimitToServer=function(){this.dataTrackApi.track("pcMail_limit_LoginDetailPage_agent")},t.getMailClientConfig=function(){var e=Object(r.a)(o.a.mark((function e(t){var n,r,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.systemApi.getUrl("getMailClientConfig"),e.next=4,this.impl.get(r,{domain:t}).then((function(e){return e.data}));case 4:if(i=e.sent,"200"!==(null===(n=null==i?void 0:i.code)||void 0===n?void 0:n.toString())){e.next=7;break}return e.abrupt("return",i.data);case 7:return e.abrupt("return",null);case 10:return e.prev=10,e.t0=e.catch(0),console.log("getMailClientConfig-catch",e.t0),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),e.waitTime=function(e){return new Promise((function(t){setTimeout(t,e)}))},t.getQRCodeStatus=function(){var t=Object(r.a)(o.a.mark((function t(n){var r,i,s,a,c,u;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,n){t.next=8;break}return t.next=4,this.systemApi.doGetCookies(!0);case 4:i=t.sent,r=i.miniapp_qrcode_uuid,t.next=9;break;case 8:r=n;case 9:if(r){t.next=11;break}return t.abrupt("return",{success:!1,errCode:"No-QrCode-Uuid",errMsg:"未获取到二维码Id，请刷新"});case 11:return t.next=13,this.impl.get(this.systemApi.getUrl("qrcodeCheck"),{p:"sirius",uuid:r}).then((function(e){return e.data}));case 13:if(null==(s=t.sent)?void 0:s.suc){t.next=16;break}return t.abrupt("return",{success:!1,errCode:null==s?void 0:s.error_code,errMsg:null==s?void 0:s.error_msg});case 16:if(!s.con){t.next=23;break}return(a=s.con).node&&this.setupNodeInfo(a.node),c="",a.loginMsg&&(c=e.getErrMsg(a.loginMsg)),u={success:!c,errMsg:c,data:{uuid:a.uuid,status:a.status,loginUrl:a.loginUrl,node:a.node,loginSuc:a.loginSuc,loginMsg:c}},t.abrupt("return",u);case 23:return t.abrupt("return",{success:!1,errCode:"No-Con-Data",errMsg:"没有Con数据，请刷新"});case 26:return t.prev=26,t.t0=t.catch(0),console.error("getQRCodeStatus Error",t.t0),t.abrupt("return",{success:!1,errCode:"Catch"});case 30:case"end":return t.stop()}}),t,this,[[0,26]])})));return function(){return t.apply(this,arguments)}}(),t.loginByQRCode=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,a,c,u,d,p,g;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,i=t.indexOf("/domain"),a=i>=0?t.substring(i):""){e.next=5;break}return e.abrupt("return",{pass:!1,errCode:"no-login-path",errmsg:"获取登录信息失败"});case 5:return c=!(window&&window.electronLib),u=""+(c?"":Object(s.config)("host"))+("bj"===n?a.replace("/domain","/bjdomain"):a),e.next=9,this.impl.post(u).then((function(e){return e.data}));case 9:return d=e.sent,e.next=12,this.processLoginResult(d);case 12:return(p=e.sent).pass&&(g=null===(r=null==d?void 0:d.data)||void 0===r?void 0:r.uid)&&this.tryReportLoginSuccess(g),e.abrupt("return",p);case 17:return e.prev=17,e.t0=e.catch(0),console.error("QRCodeLogin-error",e.t0),e.abrupt("return",{pass:!1,errCode:"catch",errmsg:e.t0.message});case 21:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),t.qrcodeCheck=function(){var t=Object(r.a)(o.a.mark((function t(n,i){var s,a,c=this;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0===i&&(i=720),s=n,n){t.next=7;break}return t.next=5,this.systemApi.doGetCookies(!0);case 5:a=t.sent,s=a.miniapp_qrcode_uuid;case 7:if(0!==i){t.next=9;break}return t.abrupt("return",{success:!1,errMsg:"超时"+i/2+"次"});case 9:return t.abrupt("return",this.impl.get(this.getUrl("qrcodeCheck"),{p:"sirius",uuid:s}).then(function(){var t=Object(r.a)(o.a.mark((function t(n){var r;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null==(r=n.data)?void 0:r.suc){t.next=3;break}return t.abrupt("return",{success:!1,errMsg:null==r?void 0:r.error_msg,errCode:null==r?void 0:r.error_code});case 3:if(!r.con){t.next=9;break}if(r.con.status!==S&&r.con.status!==x){t.next=8;break}return t.next=7,e.waitTime(1e3);case 7:return t.abrupt("return",c.qrcodeCheck(s,i-1));case 8:return t.abrupt("return",{success:!0,data:r.con});case 9:return t.abrupt("return",{success:!1});case 10:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}()).catch((function(e){return console.log("[login] qrcodeCheck check error",e),{success:!1,errMsg:""+e}})));case 10:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t.getLoginQrCodeImgUrl=function(e){var t=e&&e.w?e.w:200,n=e&&e.h?e.h:200,r=Object(c.l)()&&window&&window.electronLib?7:6;return this.systemApi.getUrl("qrCodeCreate")+"?w="+t+"&h="+n+"&type="+r+"&ts="+(new Date).getTime()},t.customHostSwitchSharedAccount=function(e,t){try{var n={hz:"hz",bj:""}[this.systemApi.getCurrentNode()||"hz"]||"",r=Object(s.config)("stage"),i="prev"===r||"prod"===r?"https://entry"+n+".qiye.163.com":"https://entrydev.qiye.163.com";return location.href=i+"/login/sharedSwitchLogin?account_name="+e+"&domain="+t,{success:!0}}catch(o){return{success:!1,errCode:"customHostSwitchSharedAccount-catcherror",errMsg:"切换公共账号失败"}}},t.switchSharedAccount=function(){var e=Object(r.a)(o.a.mark((function e(t,n){var r,i,s,a,c,u,d,g,l,h=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(r=this.handleAccountAndDomain(t)).account&&r.domain){e.next=4;break}return e.abrupt("return",{success:!1,errCode:"ParamError",errMsg:"参数错误，邮箱格式错误"});case 4:e.next=8;break;case 8:if(i=!1,s=null,a="",n){e.next=16;break}return e.next=14,this.accountApi.getSharedAccountsInfoAsync();case 14:(s=e.sent)&&(i=s.isSharedAccountLogin,a=s.isSharedAccountLogin&&!s.isSharedAccountExpired?s.email:"");case 16:return c=this.systemApi.getUrl("switchSharedAccount"),n||(this.systemApi.switchLoading(!0),this.disableBackgroundDB()),e.next=20,this.impl.get(c,Object.assign(Object.assign({},A),{account_name:r.account,domain:r.domain})).then((function(e){return e.data}));case 20:return(u=e.sent).data.isSharedAccountSwitch=!!n||(!!(s&&s.sharedAccounts&&s.sharedAccounts.some((function(e){return e.email===t})))||!i),u.data.originAccount=a,(d=this.storeApi.getCurrentNode())&&d!==this.actions.currentNode&&(this.actions.currentNode=d),e.next=27,this.processLoginResult(u);case 27:if((g=e.sent)&&g.pass){e.next=31;break}return n||(this.enableBackgroundDB(),this.systemApi.switchLoading(!1)),e.abrupt("return",{success:!1,errCode:g.errCode,errMsg:g.errmsg});case 31:if(!window){e.next=41;break}if(n){e.next=41;break}if(this.systemApi.switchLoading(!0),!window.electronLib){e.next=40;break}return e.next=37,window.electronLib.windowManage.closeAllWindowExceptMain(!0);case 37:return setTimeout((function(){h.createBKStableWindow()}),200),e.next=40,Object(p.i)(300);case 40:window.location.reload();case 41:return e.abrupt("return",{success:!0});case 44:return e.prev=44,e.t0=e.catch(0),this.systemApi.switchLoading(!1),this.enableBackgroundDB(),console.error("switchSharedAccount error",e.t0),l={success:!1,errCode:"Catch-Error",errMsg:e.t0.message},e.abrupt("return",l);case 51:case"end":return e.stop()}}),e,this,[[0,44]])})));return function(){return e.apply(this,arguments)}}(),t.getLoginCode=function(){var e=this.systemApi.getUrl("getLoginCode");return this.impl.get(e).then((function(e){var t=e.data;return 0===(null==t?void 0:t.code)&&(null==t?void 0:t.data)?t.data:""}))},t.getEntranceVisibleConfig=function(){var e=this.systemApi.getUrl("getEntranceVisibleConfig");return this.impl.get(e).then((function(e){var t=e.data;return 0===(null==t?void 0:t.code)&&(null==t?void 0:t.data)?{showTab:t.data.show,showPopup:t.data.showPopup}:{showTab:!1,showPopup:!1}}))},t.setEntrancePopupVisible=function(e){var t=this.systemApi.getUrl("setEntrancePopupVisible");return this.impl.post(t,{source:e}).then((function(e){var t=e.data;return 0===(null==t?void 0:t.code)&&!!(null==t?void 0:t.data)}))},e}();E.accountPwdAutoFilled=Object(s.config)("accountPwdAutoFilled"),E.maxLoginNoRefreshSpan=18e5,E.isInited=!1,E.defaultErrInfo=u.a["SERVER.ERR"],E.keyDeviceUUID=Object(s.config)("browerDeviceUUID"),E.AccountKey=Object(s.config)("keyOfAccount"),E.storeConfig=d.a;var M=new E;a.a.registerLogicalApi(M),t.a=M}}]);