(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{bACp:function(e,t,n){"use strict";var r=n("fGyu"),i=n("QsI/"),a=n("VtSi"),c=n.n(a),s=(n("6LKR"),n("KOtZ"),n("tQbP"),n("c2re")),u=n.n(s),o=n("2srY"),l=n.n(o),d=n("uuCm"),p=n("0HE+"),m=n("iYKj"),h=n("iNLM"),f=n("Ngo4"),b=n("qrDT"),A={"Qiye-Header":"sirius"},v={product:"sirius"},g=[],y=null,x={},w=function(){function e(){var t=this;this.contactApi=p.a.requireLogicalApi(d.a.contactApiImpl),this.loginApi=p.a.requireLogicalApi(d.a.loginApiImpl),this.performanceApi=p.a.requireLogicalApi(d.a.performanceImpl),this.dbName="account",this.tableName="account",this.subAccountTableName="subAccount",this.domainTableName="domain",this.infoTableName="accountInfo",this.encryptedPwdHead="encrypted:[",this.encryptedPwdTail="]",this.isInited=!1,this.initModule=new Set,this._accountWinInfos=[],this._currentAccountInfo=null,this.isSyncAccountInfo=!1,this.requestAccountInfoList=[],this.isSubAccountInited=!1,this.updateAccountRefreshTokenHandle={eventPeriod:"extLong",handler:function(n){n.seq>1&&n.seq%24===e.RndSyncRate&&(t.systemApi.getCurrentUser()&&(t.doUpdateAccountRefreshToken(),t.productAuthApi.saveAuthConfigFromNet()))},id:"refreshTokenAndUpdateAuthConfig",seq:0},this.currentDomainList=[],this.name=d.a.accountApiImpl,this.eventApi=p.a.getEventApi(),this.systemApi=p.a.getSystemApi(),this.storeApi=p.a.getDataStoreApi(),this.httpApi=p.a.getDataTransApi(),this.DBApi=p.a.getNewDBApi(),this.mailConfigApi=p.a.requireLogicalApi(d.a.mailConfApiImpl),this.dataTrackApi=p.a.requireLogicalApi(d.a.dataTrackerApiImp),this.productAuthApi=p.a.requireLogicalApi(d.a.productAuthApiImpl)}var t=e.prototype;return t.getSid=function(){var e=this.systemApi.getCurrentUser();return(null==e?void 0:e.sessionId)||""},t.doSyncDomainShareList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.systemApi.getIsCorpMailMode()){e.next=3;break}return e.abrupt("return",{});case 3:if(!this.getIsAccountBg()){e.next=6;break}return e.abrupt("return",{});case 6:return t=this.systemApi.getUrl("getAccountInfo"),n=this.getSid(),e.next=10,this.httpApi.get(t,{sid:n,needUnitNamePath:!1});case 10:if(r=e.sent,i=r.data.data.domainShareList,!Array.isArray(i)){e.next=16;break}return a=Object.fromEntries(i.map((function(e){return[e.orgId,e.domain]}))),this.storeApi.setUserProp("domainShareList",a,!0),e.abrupt("return",a);case 16:return e.abrupt("return",{});case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetMailAliasAccountListV2=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,a,s,u,o,l,d,p,m,h,f,A=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=(n=void 0===t?{}:t).noMain,s=void 0!==a&&a,u=n.showProxyEmails,o=void 0!==u&&u,!this.isSyncAccountInfo){e.next=3;break}return e.abrupt("return",new Promise((function(e,t){A.requestAccountInfoList.push((function(n){n&&e(n),t(new Error("request error"))}))})));case 3:if(d=this.systemApi.getUrl("getAccountInfo"),p=null===(l=this.systemApi.getCurrentUser())||void 0===l?void 0:l.id,m=this.systemApi.getIsCorpMailMode()){e.next=10;break}return e.next=9,this.mailConfigApi.getDefaultSendingAccount();case 9:h=e.sent;case 10:return f=this.getSid(),this.isSyncAccountInfo=!0,e.abrupt("return",this.httpApi.get(d,{sid:f,needUnitNamePath:!1}).then((function(e){return A.systemApi.getIsCorpMailMode()&&Object(b.a)(e),e.data})).then(function(){var e=Object(i.a)(c.a.mark((function e(t){var n,i,a,u,l,d,f,b,v,g,y,x,w,S,k,I,E,L,N,O,C,j,M,B,T,D,U,_;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.data||{},a=i.aliasList,u=void 0===a?[]:a,l=i.domainList,d=void 0===l?[]:l,f=i.domainLogo,b=void 0===f?"":f,v=i.popAccountList,g=void 0===v?[]:v,y=i.accountName,x=void 0===y?"":y,w=i.email,S=void 0===w?"":w,k=i.nickName,I=void 0===k?"":k,E=i.senderName,L=void 0===E?"":E,N=i.defaultSender,O=i.qiyeAccountId,C=i.domainShareList,Array.isArray(C)&&!A.getIsAccountBg()&&(j=C.map((function(e){return[e.orgId,e.domain]})),A.storeApi.setUserProp("domainShareList",Object.fromEntries(j),!1),A.storeApi.setUserProp("companyId","org_"+((null===(n=t.data)||void 0===n?void 0:n.orgId)||0))),Array.isArray(d)&&!A.getIsAccountBg()&&A.storeApi.setUserProp("domainList",d),O&&A.storeApi.setUserProp("contactId",O+"",!1),b&&A.storeApi.setUserProp("domainLogo",b,!1),M=u?u.map((function(e){var t,n;return{id:null==e?void 0:e.email,name:(null===(t=null==e?void 0:e.email)||void 0===t?void 0:t.split("@")[0])||"",domain:(null===(n=null==e?void 0:e.email)||void 0===n?void 0:n.split("@")[1])||"",nickName:null==e?void 0:e.nickName,senderName:null==e?void 0:e.senderName,isMainEmail:(null==e?void 0:e.email)===S,isDefault:(null==e?void 0:e.email)===(null==N?void 0:N.email),mailEmail:S}})):[],B=d?d.map((function(e){return{id:x+"@"+e,name:x||I,domain:e,senderName:L,isMainEmail:x+"@"+e===S,isDefault:(null==N?void 0:N.email)===x+"@"+e,mailEmail:S,nickName:I}})):[],T=g?null==g?void 0:g.map((function(e){var t=e.email,n=e.nickName,r=e.senderName,i=void 0===r?"":r;return{id:t,name:n,domain:null==t?void 0:t.split("@")[1],isProxy:!0,nickName:n,senderName:i,isMainEmail:!1,mailEmail:t,isDefault:t===h}})):[],D=o?[].concat(Object(r.a)(M),Object(r.a)(B),Object(r.a)(T)):[].concat(Object(r.a)(M),Object(r.a)(B)),U=D.sort((function(e,t){return e.isDefault?-1:t.isDefault?1:0})).reduce((function(e,t){return e.some((function(e){return e.id===t.id}))?e:[].concat(Object(r.a)(e),[t])}),[]),m&&(_=A.systemApi.getCurrentUser(),!!U.find((function(e){return e.id===(null==_?void 0:_.id)}))||U.push({nickName:(null==_?void 0:_.nickName)||(null==_?void 0:_.accountName)||x,name:x,id:null==_?void 0:_.id,domain:null==_?void 0:_.domain})),A.storeApi.setUserProp("accountAlias",U.filter((function(e){return!e.isProxy})).map((function(e){return e.id})),!0),s&&(U=U.filter((function(e){return e.id!==p}))),A.isSyncAccountInfo=!1,A.requestAccountInfoList.forEach((function(e){e(U)})),e.abrupt("return",U);case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()).catch((function(e){return console.error(e),A.isSyncAccountInfo=!1,A.requestAccountInfoList.forEach((function(e){e(void 0)})),[]})));case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getEmail=function(){var e=this.systemApi.getCurrentUser();return null==e?void 0:e.id},t.getBindAccounts=function(e){return console.log(e),[]},t.init=function(){var e,t=this;return this.systemApi.getCurrentUser()&&this.systemApi.isMainPage()&&this.productAuthApi.saveAuthConfigFromNet(),this.DBApi.addFilterRegistry({filterFunc:function(e,t){var n,r,i,a,c,s;return!!((null==t?void 0:t.additionalData)&&t.additionalData.mobile&&t.additionalData.accountId)&&("mobile"===(null===(n=null==t?void 0:t.additionalData)||void 0===n?void 0:n.type)?"mobile"===e.type&&e.mobile===(null===(r=null==t?void 0:t.additionalData)||void 0===r?void 0:r.mobile):"alias"===(null===(i=null==t?void 0:t.additionalData)||void 0===i?void 0:i.type)?"alias"===e.type&&e.accountId===(null===(a=null==t?void 0:t.additionalData)||void 0===a?void 0:a.accountId):"mobile"===e.type&&e.mobile===(null===(c=null==t?void 0:t.additionalData)||void 0===c?void 0:c.mobile)||"alias"===e.type&&e.accountId===(null===(s=null==t?void 0:t.additionalData)||void 0===s?void 0:s.accountId))},name:"accountItemFilterName"}),this.eventApi.registerSysEventObserver("updateUserInfo",{name:"loginChangeAccountOb",func:(e=Object(i.a)(c.a.mark((function e(){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=t.systemApi.getCurrentUser())){e.next=5;break}return e.next=4,t.doSaveCurrentAccount(n);case 4:t.eventApi.sendSimpleSysEvent("accountNotify");case 5:case"end":return e.stop()}}),e)}))),function(){return e.apply(this,arguments)})}),this.eventApi.registerSysEventObserver("initModule",{name:"initModuleOb",func:function(e){e.eventStrData&&t.initModule.add(e.eventStrData)}}),this.updateLocalSubAccountsCache(),this.handleSubAccountDeleted(),this.handleSubAccountDBChanged(),this.systemApi.isMainPage()&&this.eventApi.registerSysEventObserver("sharedAccountLogout",{name:"",func:function(e){if(e&&e.eventData){var n=e.eventData.id;t.handleSharedAccountLogout(n)}}}),this.name},t.handleSubAccountDBChanged=function(){var e=this;window&&window.isAccountBg||!1||["subAccountDBChanged","SubAccountDeleted","SubAccountWindowReady"].forEach((function(t){e.eventApi.registerSysEventObserver(t,{name:"accountApi-"+t,func:function(){e.updateLocalSubAccountsCache()}})}))},t.handleSubAccountDeleted=function(){var e=this;(this.systemApi.isMainPage()||window&&window.isBridgeWorker)&&this.eventApi.registerSysEventObserver("SubAccountDeleted",{name:"accountApi-handleSubAccountDeleted",func:function(t){if(t&&t.eventData){var n=t.eventData.subAccount,r=e.systemApi.md5(n,!0);e.DBApi.removeAccountAction(r)}}})},t.afterInit=function(){!window||window.isAccountBg;return this.systemApi.getCurrentUser(),console.warn("[register_impl] afterInit"),this.name},t.afterLogin=function(){return this.name},t.beforeLogout=function(){return this.name},t.updateServerAliasList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.systemApi.getCurrentUser(),e.next=4,this.doGetMailAliasAccountListV2({noMain:!1,showProxyEmails:!0});case 4:return n=e.sent,r=this.transAlias(n,t.id),e.next=8,this.checkAccountInfoListDiff(r,"alias");case 8:return i=e.sent,a=i.deleteDiff,e.next=12,Promise.all([this.doDeleteAccountInfoList(a),this.storeAccountInfoList(r)]);case 12:this.eventApi.sendSimpleSysEvent("accountNotify"),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("[account_impl] updateServerAliasList error",e.t0);case 18:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),t.updateServerMobileList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getServerMobileBindAccountList();case 3:return t=e.sent,n=this.transMobile(t),e.next=7,this.checkAccountInfoListDiff(n,"mobile");case 7:return r=e.sent,i=r.deleteDiff,e.next=11,this.doDeleteAccountInfoList(i);case 11:return e.next=13,this.storeAccountInfoList(n);case 13:this.eventApi.sendSimpleSysEvent("accountNotify"),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("[account_impl] updateServerMobileList error",e.t0);case 19:case"end":return e.stop()}}),e,this,[[0,16]])})));return function(){return e.apply(this,arguments)}}(),t.doGetAccountIsAdmin=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this.systemApi.getIsCorpMailMode()){e.next=4;break}return e.abrupt("return",Promise.resolve(!1));case 4:return n=this.systemApi.getUrl("getIsAdmin"),e.next=7,this.httpApi.post(n,Object.assign({},v),{headers:Object.assign({},A),timeout:2e4});case 7:if(r=e.sent,i=r.data||{},a=i.code,s=void 0===a?"":a,u=i.result,"200"!==String(s)||!u){e.next=11;break}return e.abrupt("return",Boolean(null===(t=u.data)||void 0===t?void 0:t.admin));case 11:return console.error("[account_impl] doGetAccountIsAdmin error",s,u),e.abrupt("return",!1);case 15:return e.prev=15,e.t0=e.catch(0),console.error("[account_impl] doGetAccountIsAdmin error",e.t0),e.abrupt("return",!1);case 19:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),t.doGetAccountBindAndForwardInfo=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.systemApi.getUrl("getBindAndForwardInfo"),e.next=3,this.httpApi.post(t,Object.assign({},v),{headers:Object.assign({},A),timeout:2e4});case 3:if(n=e.sent,r=n.data||{},i=r.code,a=void 0===i?"":i,s=r.result,u=r.error,"200"!==String(a)||!s){e.next=7;break}return e.abrupt("return",s);case 7:return e.abrupt("return",{error:u||"otherError"});case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doSendVerificationCode=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.systemApi.getUrl("sendVerificationCode"),e.next=3,this.httpApi.post(t,Object.assign({},v),{headers:Object.assign({},A),timeout:2e4});case 3:if(n=e.sent,r=n.data||{},i=r.code,a=void 0===i?"":i,s=r.result,u=r.error,"200"!==String(a)||!s){e.next=7;break}return e.abrupt("return",{success:!0,result:s});case 7:return e.abrupt("return",{success:!1,error:u||"验证码获取失败，请稍后再试"});case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doCheckVerificationCode=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s,u,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.systemApi.getUrl("checkVerificationCode"),e.next=3,this.httpApi.get(n,{vcode:t},{headers:Object.assign({},A),contentType:"json"});case 3:if(r=e.sent,i=r.data||{},a=i.code,s=void 0===a?"":a,u=i.result,o=i.error,"200"!==String(s)||!u){e.next=7;break}return e.abrupt("return",{success:!0,result:u});case 7:return e.abrupt("return",{success:!1,error:o||"otherError"});case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetAccountBindInfo=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u,o,l,d,p,m;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.systemApi.getCurrentUser()){e.next=2;break}return e.abrupt("return","");case 2:return e.prev=2,t=this.systemApi.getUrl("getBindInfo"),e.next=6,this.httpApi.post(t,Object.assign({},v),{headers:Object.assign({},A),timeout:2e4});case 6:if(n=e.sent,r=n.data||{},i=r.code,a=void 0===i?"":i,s=r.result,u=r.error,"200"!==String(a)||!s){e.next=15;break}if(o=(null==s?void 0:s.bindInfo)||{},l=o.mobile,d=o.mobile_login_enable,p=o.mobile_login_time,m=void 0===p?0:p,e.t0=l,!e.t0){e.next=14;break}return e.next=14,this.updateCurrentAccount({mobile:l,lastLoginTime:m,enabledMobileLogin:d});case 14:return e.abrupt("return",l);case 15:return console.error("[account_impl] doGetAccountBindInfo error",a,s),e.abrupt("return",u||"otherError");case 19:return e.prev=19,e.t1=e.catch(2),console.error("[account_impl] doGetAccountBindInfo error",e.t1),e.abrupt("return","otherError");case 23:case"end":return e.stop()}}),e,this,[[2,19]])})));return function(){return e.apply(this,arguments)}}(),t.getServerMobileBindAccountList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,i,a,s,u,o,l,d,p,m,h,f,b;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.systemApi.getUrl("getBindAccountList"),n=this.systemApi.getUrl("getBJBindAccountList"),i=this.systemApi.getCurrentUser(),e.next=6,Promise.all([this.httpApi.post(t,Object.assign(Object.assign({},v),{mobile:null==i?void 0:i.mobile}),{headers:Object.assign({},A),timeout:2e4}),this.httpApi.post(n,Object.assign(Object.assign({},v),{mobile:null==i?void 0:i.mobile}),{headers:Object.assign({},A),timeout:2e4})]);case 6:if(a=e.sent,s=a[0],u=a[1],o=s.data||{},l=o.code,d=void 0===l?"":l,p=o.result,m=u.data||{},h=m.code,f=void 0===h?"":h,b=m.result,!("200"===String(d)&&p||"200"===String(f)&&b)){e.next=13;break}return e.abrupt("return",[].concat(Object(r.a)((null==p?void 0:p.data)||[]),Object(r.a)((null==b?void 0:b.data)||[])));case 13:return console.error("[account_impl] getServerMobileBindAccountList error",d,p,f,b),e.abrupt("return",[]);case 17:return e.prev=17,e.t0=e.catch(0),console.error("[account_impl] getServerMobileBindAccountList error",e.t0),e.abrupt("return",[]);case 21:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),t.checkAccountInfoListDiff=function(){var e=Object(i.a)(c.a.mark((function e(t,n){var r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getStoreAccountInfoList(n);case 2:return r=e.sent,i=h.h.getKeyListByList(r,"id",!0),a=h.h.getKeyListByList(t,"id",!0),e.abrupt("return",h.h.getDiff(i,a));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetAllAccountList=function(){var e=this.getAccountTableName();return Promise.all([this.DBApi.getByEqCondition({dbName:this.dbName,tableName:e}),this.DBApi.getByEqCondition({dbName:this.dbName,tableName:this.infoTableName})])},t.storeAccountList=function(e){var t=e&&e.length?e.filter((function(e){return!e.isSharedAccount})):[];if(!t||!t.length)return Promise.resolve([]);var n=this.getAccountTableName();return this.DBApi.putAll({dbName:this.dbName,tableName:n},t)},t.storeAccountInfoList=function(e){return this.DBApi.putAll({dbName:this.dbName,tableName:this.infoTableName},e)},t.doDeleteAccountList=function(){var e=Object(i.a)(c.a.mark((function e(t){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.length){e.next=2;break}return e.abrupt("return",!0);case 2:return e.prev=2,e.next=5,this.DBApi.deleteById({dbName:this.dbName,tableName:this.tableName},t);case 5:e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(2),console.error("[account] db delete:",t,e.t0),e.abrupt("return",!1);case 11:return e.abrupt("return",!0);case 12:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(){return e.apply(this,arguments)}}(),t.doDeleteAccountInfoList=function(e){return this.DBApi.deleteById({dbName:this.dbName,tableName:this.infoTableName},e)},t.getAccountTableName=function(){return!(!window||!window.isAccountBg)?this.subAccountTableName:this.tableName},t.getStoreAccountList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.getAccountTableName(),e.next=4,Promise.all([this.DBApi.getByEqCondition({dbName:this.dbName,tableName:t}),this.getStoreAccountInfoList()]);case 4:return n=e.sent,r=n[0],i=n[1],e.next=9,this.getSharedAccountsInfoAsync();case 9:return a=e.sent,e.abrupt("return",this.transModal(r,i,a));case 13:return e.prev=13,e.t0=e.catch(0),console.error("[account_impl] getStoreAccountList error",e.t0),e.abrupt("return",Promise.reject(e.t0));case 17:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}(),t.getStoreAccountInfoList=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.systemApi.getCurrentUser()){e.next=3;break}return e.abrupt("return",[]);case 3:return r=n.mobile,i=n.id,e.next=6,this.DBApi.getByEqCondition({dbName:this.dbName,tableName:this.infoTableName,additionalData:{mobile:r,accountId:i,type:t},filter:["accountItemFilterName"]});case 6:return a=e.sent,e.abrupt("return",a);case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.transModal=function(e,t,n){var r=this.systemApi.getCurrentUser(),i=this.orderByLastLoginTime(e),a=[],c=!0,s=[];return r&&(t.forEach((function(t){"alias"!==t.type||t.isDefault?"mobile"===t.type&&((null==r?void 0:r.id)===t.accountId&&(r.enabledMobileLogin=t.enabledMobileLogin,r.lastLoginTime=t.lastLoginTime||0,r.enabledMobileLogin&&r.lastLoginTime>0||(c=!1,a=[])),c&&!e.some((function(e){return e.id===t.accountId}))&&a.push(t)):s.push(t)})),i=i.filter((function(e){return e.id!==r.id&&!s.some((function(t){return t.accountId===e.id}))})).filter((function(e){return!n||(!n.isSharedAccountLogin||e.id!==n.email)})),a=this.orderByLastLoginTime(a)),u()({current:r,localList:i,mobileList:a,aliasList:s})},t.transAlias=function(e,t){return e.map((function(e){var n=e.name,r=e.id,i=e.domain,a=e.isProxy,c=e.isDefault;return{id:h.h.getUnique(t,"alias",n,i),originId:r,accountId:t,type:"alias",domain:i,accountName:n,isDefault:c,isProxy:a,updateTime:(new Date).getTime()}}))},t.transMobile=function(e){var t=this,n=[];return e.forEach((function(e){var r=e.account_id,i=e.domain,a=e.account_name,c=e.mobile,s=e.mobile_login_time,u=e.mobile_login_enable,o=e.status,l=t.doGetAccount({accountName:a,domain:i});n.push({id:h.h.getUnique(l,"mobile",c),accountId:l,originId:r,type:"mobile",mobile:c,status:o,enabledMobileLogin:u,lastLoginTime:s,updateTime:(new Date).getTime()})})),n},t.transUser=function(e){var t,n=e.id,r=e.avatar,i=e.lastLoginTime,a=e.originId,c=e.mobile;return!(!window||!window.isAccountBg)||c&&(t={id:h.h.getUnique(n,"mobile",c),accountId:n,type:"mobile",originId:a,mobile:c,avatar:r,lastLoginTime:i,enabledMobileLogin:!0,updateTime:(new Date).getTime()}),{accountList:u()(e),infoList:t}},t.testPwdStyleIsNew=function(e){return e.startsWith(this.encryptedPwdHead)&&e.endsWith(this.encryptedPwdTail)},t.decryptByKey=function(e){var t=e.replace(this.encryptedPwdHead,"").replace(this.encryptedPwdTail,"");return this.systemApi.decryptByKey(t,this.storeApi.getUUID())},t.transStorageAccount=function(e){var t=this;return e.map((function(e){var n,r=e.a,i=e.k,a=e.lastLogin,c=e.t,s=e.tExpire,u=e.mobile,o=e.user,l="";if(i)if(t.testPwdStyleIsNew(i)){var d=t.decryptByKey(i);l=t.systemApi.md5(d)}else l=i;if(o)n=Object.assign(Object.assign({},o),{lastLoginTime:a,pwd:l});else{var p=t.systemApi.handleAccountAndDomain(r);n={id:r,pwd:l,accountName:p.account,domain:p.domain,accountMd5:t.systemApi.md5(r,!0),company:"",nickName:"",avatar:"",refreshToken:c,refreshTokenExpire:s,mobile:u,lastLoginTime:a,sessionId:""}}return n}))},t.doUpdateAccountList=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=h.h.getKeyListByList(t,"id",!0),e.next=3,this.doGetAccountInfo(n);case 3:return r=e.sent,i=h.h.listToMap(r,"id"),a=t.map((function(e){return Object.assign(Object.assign({},i[e.id]||{}),e)})),e.abrupt("return",this.storeAccountList(a));case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetAccount=function(e){var t=e.accountName,n=e.domain;return t&&n?t+"@"+n:(console.error("accountName domain cannot be none"),"")},t.doGetMobileAndArea=function(e){if(!e)return{mobile:"",mobileArea:""};if(-1===e.indexOf(")"))return{mobile:e,mobileArea:"86"};var t=e.split(")");return{mobile:t[1],mobileArea:t[0].slice(1)}},t.doGetMobileAccountInfo=function(e){return this.DBApi.getByEqCondition({dbName:this.dbName,tableName:this.infoTableName,query:{id:e}})},t.doGetAllMainAndSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.doGetAccountInfo();case 2:if(e.t0=e.sent,e.t0){e.next=5;break}e.t0=[];case 5:return t=e.t0,e.next=8,this.getSubAccounts({expired:!1});case 8:if(e.t1=e.sent,e.t1){e.next=11;break}e.t1=[];case 11:return n=e.t1,e.abrupt("return",n.concat(t));case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetAccountInfo=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.getAccountTableName(),t&&t.length&&(window.isAccountBg?(i=this.systemApi.getMainAccount(),n={type:"anyOf",args:[t.map((function(e){return[i.email,e]}))],field:"[mainAccount+id]"}):n={type:"anyOf",args:[t],field:"id"}),e.abrupt("return",this.DBApi.getByRangeCondition({dbName:this.dbName,tableName:r,adCondition:n}));case 6:return e.prev=6,e.t0=e.catch(0),console.error("[contact_impl] doGetAccountInfo error",e.t0),e.abrupt("return",[]);case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}(),t.getIsAccountBg=function(){return!!Object(d.l)()&&(window&&window.isAccountBg)},t.doSaveCurrentAccount=function(){var t=Object(i.a)(c.a.mark((function t(n){var r,i,a,s,u,o;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=Object.assign(Object.assign({},n),e.isSaveCurrentUser||{}),e.isSaveCurrentUser=r,i=this.transUser(r),a=i.accountList,s=i.infoList,u=[],this.getIsAccountBg()&&!a.mainAccount&&a&&(o=this.systemApi.getMainAccount().email)&&(a.mainAccount=o),a.mainAccount?u.push(this.addOrUpdateLocalSubAccounts([a])):u.push(this.doUpdateAccountList([a])),s&&u.push(this.storeAccountInfoList([s])),t.next=11,Promise.all(u);case 11:return e.isSaveCurrentUser=void 0,console.log("doSaveCurrentAccount success"),t.abrupt("return",{success:!0});case 16:return t.prev=16,t.t0=t.catch(0),t.abrupt("return",{success:!1,message:t.t0.message});case 19:case"end":return t.stop()}}),t,this,[[0,16]])})));return function(){return t.apply(this,arguments)}}(),t.doGetAccountList=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=!0),e.prev=1,n=this.systemApi.getIsCorpMailMode(),r=this.systemApi.getCurrentUser(),t||n||!r||(r.mobile&&this.updateServerMobileList().then(),this.updateServerAliasList().then()),e.next=7,this.getStoreAccountList();case 7:return i=e.sent,!this.systemApi.isElectron()&&i&&(i.mobileList=[]),e.abrupt("return",i);case 12:return e.prev=12,e.t0=e.catch(1),console.error("[account_impl] doGetAccountList error",e.t0),e.abrupt("return",Promise.reject(e.t0));case 16:case"end":return e.stop()}}),e,this,[[1,12]])})));return function(){return e.apply(this,arguments)}}(),t.doTransMobileBindAccountList=function(e){try{return e.map((function(e){var t=e.domain,n=e.account_name,r=e.status,i=e.token,a=e.mobile_login_enable,c=e.mobile_login_time,s=e.mobile,u=e.account_exp,o=e.area;return{domain:t,accountName:n,status:r,expired:u,enabledMobileLogin:a,lastLoginTime:c,nickName:e.nickname,token:i,mobile:s,area:o}}))}catch(t){return console.error("[account_impl] doTransMobileBindAccountList error",t),[]}},t.doCleanAllAccount=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.doGetAccountList();case 3:return t=e.sent,n=h.h.getKeyListByList(t.localList,"id",!0),t.current&&n.push(t.current.id),r=h.h.getKeyListByList(t.mobileList,"id",!0),e.next=9,Promise.all([this.doDeleteAccountList(n),this.doDeleteAccountInfoList(r)]);case 9:return e.abrupt("return",{success:!0});case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",{success:!1,message:"清除失败"});case 15:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),t.doGetVerifyCode=function(){var e=Object(i.a)(c.a.mark((function e(t,n){var r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.httpApi.buildUrl(this.systemApi.getUrl(n?"getCancelVerifyCode":"getVerifyCode"),Object.assign(Object.assign({},v),{mobile:t})),e.next=4,this.httpApi.post(r,{},{headers:Object.assign({},A)});case 4:return i=e.sent,a=i.data,e.abrupt("return",{success:"200"===String(null==a?void 0:a.code),message:null==a?void 0:a.error});case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",{success:!1,message:e.t0.message});case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(){return e.apply(this,arguments)}}(),t.updateCurrentAccount=function(e){var t=this.systemApi.getCurrentUser(),n=Object.assign(t,e);return Promise.all([this.storeApi.setLastAccount(n),this.doSaveCurrentAccount(n)])},t.doBindMobile=function(){var e=Object(i.a)(c.a.mark((function e(t,n){var r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.httpApi.buildUrl(this.systemApi.getUrl("bindMobile"),Object.assign(Object.assign({},v),{code:t})),e.next=4,this.httpApi.post(r,Object.assign({},v),{headers:Object.assign({},A)});case 4:if(i=e.sent,a=i.data,"200"!==String(null==a?void 0:a.code)){e.next=10;break}return e.next=9,this.updateCurrentAccount({mobile:n});case 9:return e.abrupt("return",{success:!0});case 10:return e.abrupt("return",{success:!1,message:f.a[null==a?void 0:a.error]||(null==a?void 0:a.error)});case 13:return e.prev=13,e.t0=e.catch(0),console.error("[account_impl] doUnBindMobile error",e.t0),e.abrupt("return",{success:!1,message:e.t0.message});case 17:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}(),t.doUpdateBindMobile=function(){var e=Object(i.a)(c.a.mark((function e(t,n){var r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.httpApi.buildUrl(this.systemApi.getUrl("updateBindMobile"),Object.assign(Object.assign({},v),{code:t})),e.next=4,this.httpApi.post(r,Object.assign({},v),{headers:Object.assign({},A)});case 4:if(i=e.sent,a=i.data,"200"!==String(null==a?void 0:a.code)){e.next=10;break}return e.next=9,this.updateCurrentAccount({mobile:n});case 9:return e.abrupt("return",{success:!0});case 10:return e.abrupt("return",{success:!1,message:f.a[null==a?void 0:a.error]||(null==a?void 0:a.error)});case 13:return e.prev=13,e.t0=e.catch(0),console.error("[account_impl] doUnBindMobile error",e.t0),e.abrupt("return",{success:!1,message:e.t0.message});case 17:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}(),t.doUnBindMobile=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=this.httpApi.buildUrl(this.systemApi.getUrl("unbindMobile"),Object.assign(Object.assign({},v),{code:t})),e.next=4,this.httpApi.post(n,Object.assign({},v),{headers:Object.assign({},A)});case 4:if(r=e.sent,i=r.data,"200"!==String(null==i?void 0:i.code)){e.next=10;break}return e.next=9,this.removeCurrentMobile();case 9:return e.abrupt("return",{success:!0});case 10:return e.abrupt("return",{success:!1,message:f.a[null==i?void 0:i.error]||("ERR.FORBIDDEN"===(null==i?void 0:i.error)?"帐号开启了二次验证，无法解绑手机号":null==i?void 0:i.error)});case 13:return e.prev=13,e.t0=e.catch(0),console.error("[account_impl] doUnBindMobile error",e.t0),e.abrupt("return",{success:!1,message:e.t0.message});case 17:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}(),t.doSaveStorageAccount=function(e){console.log("[account] save login ",e);var t=this.transStorageAccount(e);return this.storeAccountList(t)},t.removeCurrentMobile=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.systemApi.getCurrentUser(),e.prev=1,!(null==t?void 0:t.mobile)){e.next=7;break}return n=Object.assign(Object.assign({},t),{mobile:void 0}),r=this.getMobileAccountInfoId(t),e.next=7,Promise.all([this.storeApi.setLastAccount(n),this.doSaveCurrentAccount(n),this.doDeleteAccountInfoList([r])]);case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),console.error("[account_impl removeCurrentMobile error]",e.t0);case 12:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(){return e.apply(this,arguments)}}(),t.getCurrentAccountInfo=function(){var e=Object(i.a)(c.a.mark((function e(t){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.systemApi.getUrl("getYunxinInfoByEmail"),e.abrupt("return",this.fetchAccountAndToken(n,{emailList:t}));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.fetchAccountAndToken=function(){var e=Object(i.a)(c.a.mark((function e(t,n){var r,a,s,u=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.systemApi.handleAccountAndDomain(n.emailList),e.next=3,this.httpApi.get(t,{domain:r.domain,emailList:n.emailList});case 3:return a=e.sent,s=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=a.data)&&"200"===String(r.code)&&r.data){e.next=5;break}console.error("getYunxinInfoByEmail Failed:",a),e.next=8;break;case 5:if(!(i=((null===(n=r.data)||void 0===n?void 0:n.itemList)||[]).filter((function(e){return 0===e.status}))).length){e.next=8;break}return e.abrupt("return",i[0]);case 8:return e.next=10,Object(h.i)(1e3*t+500);case 10:if(!(t<3)){e.next=12;break}return e.abrupt("return",s(t+1));case 12:return u.eventApi.sendSysEvent({eventName:"error",eventLevel:"error",eventStrData:"",eventData:{popupType:"window",popupLevel:"error",title:f.a.IM_AUTH_FAIL,code:"IM_AUTH_FAIL"},eventSeq:0}),e.abrupt("return",Promise.reject(new Error("超过重试次数")));case 14:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.abrupt("return",s(0));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getMobileAccountInfoId=function(e){return h.h.getUnique(e.id,"mobile",e.mobile)},t.orderByLastLoginTime=function(e){return(null==e?void 0:e.length)>1&&e.sort((function(e,t){return(null==e?void 0:e.lastLoginTime)?(null==t?void 0:t.lastLoginTime)?-(e.lastLoginTime-t.lastLoginTime):-1:(null==t?void 0:t.lastLoginTime)?1:0})),e},t.doUpdateAccountRefreshToken=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u,o,l,d;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=this.systemApi.getCurrentUser())&&!this.systemApi.isElectron()){e.next=3;break}return e.abrupt("return");case 3:if(n=Date.now(),r=t.domain,i=t.accountName,a=t.refreshTokenExpire,s=void 0===a?0:a,u=t.refreshToken,o=void 0===u?"":u,!(s-n<=2592e5)){e.next=11;break}return e.next=8,this.loginApi.doUpdateRefreshToken({account_name:i,domain:r,tokenExpire:s,token:o});case 8:l=e.sent,d=l.success,this.performanceApi.point({statKey:"update_refreshToken",statSubKey:d?"success":"fail",value:1,valueType:4});case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.transDomainList=function(){var e=Object(i.a)(c.a.mark((function e(t){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getCurrentOrgId();case 2:if(!(n=e.sent)){e.next=5;break}return e.abrupt("return",t.map((function(e){return{id:h.h.getUnique(n,e.domain),orgId:n,domain:e.domain,type:void 0===e.type?-1:e.type}})));case 5:return e.abrupt("return",[]);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.storeDomainList=function(e){return this.DBApi.putAll({dbName:this.dbName,tableName:this.domainTableName},e)},t.getServerDomainList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.httpApi.get(this.systemApi.getUrl("getDomainListByOrg"));case 3:if(n=e.sent,!(null==(r=n.data)?void 0:r.success)||!(null===(t=null==r?void 0:r.data)||void 0===t?void 0:t.domainList)){e.next=12;break}return e.next=8,this.transDomainList(r.data.domainList);case 8:return i=e.sent,e.next=11,this.storeDomainList(i);case 11:return e.abrupt("return",{success:!0,data:i});case 12:return e.abrupt("return",{success:!1});case 15:return e.prev=15,e.t0=e.catch(0),console.error("[account_impl] getServerDomainList error",e.t0),e.abrupt("return",{success:!1,message:e.t0.message});case 19:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),t.getCurrentOrg=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.contactApi.doGetOrgList({typeList:[99]});case 2:return t=e.sent,e.abrupt("return",t[0]);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getCurrentOrgId=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getCurrentOrg();case 2:return t=e.sent,e.abrupt("return",null==t?void 0:t.originId);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetEmailInCurrentDomain=function(e){var t=this.systemApi.handleAccountAndDomain(e).domain;return this.currentDomainList.some((function(e){return e.domain===t}))},t.doGetDomainList=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getCurrentOrgId();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",[]);case 5:return e.next=7,this.DBApi.getByEqCondition({dbName:this.dbName,tableName:this.domainTableName,query:{orgId:t}});case 7:return n=e.sent,this.currentDomainList=n,e.abrupt("return",n);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.doGetInitModule=function(){return this.initModule},t.putSubAccounts=function(e){return this.DBApi.putAll({dbName:this.dbName,tableName:this.subAccountTableName},e)},t.deleteLocalSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(t){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=this.getSubAccountQueryConfig(t),e.next=4,this.DBApi.deleteByByRangeCondition(n);case 4:return this.updateLocalSubAccountsCache(),e.abrupt("return",!0);case 8:return e.prev=8,e.t0=e.catch(0),console.error("deleteSubAccounts error",e.t0),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),t.deleteAllSubAccountDB=function(e){var t=this;if(e&&e.length){var n=this.systemApi.md5(e,!0);["catalog_dexie","contact_dexie","fileop","mail_new","task_mail"].forEach((function(e){t.DBApi.deleteDB(e+"_"+n)}))}},t.addOrUpdateLocalSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.length){e.next=2;break}return e.abrupt("return",[]);case 2:return n={dbName:this.dbName,tableName:this.subAccountTableName},e.next=5,this.DBApi.getByRangeCondition(n);case 5:return(r=e.sent)&&r.length&&t.forEach((function(e,n){var i=r.find((function(t){return t.id===e.id&&t.mainAccount===e.mainAccount}));e.rowId&&delete e.rowId,i&&(t[n]=Object.assign(Object.assign({},i),e))})),e.next=9,this.putSubAccounts(t);case 9:return i=e.sent,setTimeout((function(){a.updateLocalSubAccountsCache()}),10),e.abrupt("return",i);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getSubAccountQueryConfig=function(e){var t={dbName:this.dbName,tableName:this.subAccountTableName};if(!e||!e.mainAccountEmail){var n=this.systemApi.getCurrentUser(),r=null==n?void 0:n.id;e||(e={mainAccountEmail:r}),e.mainAccountEmail||(e.mainAccountEmail=r)}return e&&(e.mainAccountEmail&&e.subAccountEmail?t.adCondition={field:"[mainAccount+id]",type:"equals",args:[[e.mainAccountEmail,e.subAccountEmail]]}:e.mainAccountEmail?t.adCondition={field:"mainAccount",type:"equals",args:[e.mainAccountEmail]}:e.subAccountEmail&&(t.adCondition={field:"id",type:"equals",args:[e.subAccountEmail]})),t},t.getMainAndSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.systemApi.getCurrentUser()){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,this.getSubAccounts(t);case 5:return r=e.sent,i=Object.assign(Object.assign({accountType:"mainAccount"},n),{emailType:"NeteaseQiYeMail",mainAccount:null==n?void 0:n.id,expired:!1,agentEmail:null==n?void 0:n.id}),r.unshift(i),e.abrupt("return",r);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getLocalSubAccountsFromCache=function(e){var t=this,n=g||[];return n&&(null==n?void 0:n.length)?n.filter((function(n){var r=e&&e.mainAccountEmail?e.mainAccountEmail:"";if(!r){var i=t.systemApi.getCurrentUser();r=null==i?void 0:i.id}return n.mainAccount===r})).filter((function(t){var n=e&&e.subAccountEmail?e.subAccountEmail:"";return!n||(n===t.agentEmail||t.id===n)})).filter((function(t){var n=e&&void 0!==e.expired?e.expired:"";return""===n||t.expired===n})):[]},t.getIsSameSubAccountSync=function(e,t){var n,r;if(window.isAccountBg)return!0;if(!e&&!t)return!0;var i=e;e||(i=null===(n=this.systemApi.getCurrentUser())||void 0===n?void 0:n.id);var a=t;return t||(a=null===(r=this.systemApi.getCurrentUser())||void 0===r?void 0:r.id),!e&&t||!t&&e?a===i:!(!e||!t||e!==t)||a===x[i]},t.getSubAccountInfo=function(e){try{var t=g;if(!t||!t.length)return null;var n=t.find((function(t){return t.id===e||t.agentEmail===e}));if(n)return n}catch(r){console.error("[Errorf]getSubAccountInfo",r)}return null},t.updateLocalSubAccountsCache=function(){var e=Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getSubAccounts();case 3:g=e.sent,x={},g&&g.length&&g.forEach((function(e){e.id&&(x[e.id]=e.agentEmail||e.id,e.agentEmail&&e.id!==e.agentEmail&&(x[e.agentEmail]=e.id||e.agentEmail))})),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("updateLocalSubAccountsCache-error",e.t0);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),t.getSubAccountSid=function(e){try{var t=g;if(!t||!t.length)return"";var n=t.find((function(t){return t.id===e||t.agentEmail===e}));return n?n.sessionId:""}catch(r){return console.error("getSubAccountSid-error",r),""}},t.getNodeInfoByEmail=function(e){try{if(this.getIsAccountBg())return this.storeApi.getCurrentNode();var t=g;if(!t||!t.length)return"";var n=t.find((function(t){return t.id===e||t.agentEmail===e}));return n&&n.node||""}catch(r){return console.error("getNodeInfoByEmail-error",r),""}},t.addEmailTypeToSubAccount=function(e){try{if(e){if(e.emailType)return;if("qyEmail"===e.accountType||"mainAccount"===e.accountType)return void(e.emailType="NeteaseQiYeMail");var t=e.agentEmail;if(t)switch(t.split("@")[1]){case"qq.com":e.emailType="QQMail";break;case"163.com":e.emailType="163Mail";break;default:e.emailType="Others"}}}catch(n){console.error(n)}},t.getSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;break;case 2:return n=this.getSubAccountQueryConfig(t),e.next=5,this.DBApi.getByRangeCondition(n);case 5:return r=e.sent,i=r,t&&void 0!==t.expired&&(i=r.filter((function(e){return e.expired===t.expired}))),i.forEach((function(e){a.addEmailTypeToSubAccount(e)})),e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getAccountWinInfos=function(e){return e&&e.email?this._accountWinInfos.filter((function(t){return t.email===e.email})):e&&e.winId?this._accountWinInfos.filter((function(t){return t.winId===e.winId})):this._accountWinInfos},t.removeAccountWinInfo=function(e){if(!e||!e.length)return!1;if(!this._accountWinInfos||!this._accountWinInfos.length)return!1;var t=this._accountWinInfos.findIndex((function(t){return t.email===e}));return t>=0&&(this._accountWinInfos.splice(t,1),!0)},t.getIsWinInfoExisted=function(e){return!(!this._accountWinInfos||!this._accountWinInfos.length)&&!!this._accountWinInfos.find((function(t){return t.email===e}))},t.updateAccountWinInfosToMainProcess=function(){var e=Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!window||!window.electronLib){e.next=3;break}return e.next=3,window.electronLib.storeManage.set("memory","accountWinInfos",this._accountWinInfos);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getAccountWinInfosFromMainProcess=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!window||!window.electronLib){e.next=8;break}return e.next=3,window.electronLib.storeManage.get("memory","accountWinInfos");case 3:return n=e.sent,r=n||[],t&&t.email&&(r=r.filter((function(e){return e.email===t.email}))),t&&t.winId&&(r=r.filter((function(e){return e.winId===t.winId}))),e.abrupt("return",r);case 8:return e.abrupt("return",[]);case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),t.addAccountWinInfo=function(e){var t=this;return e&&e.email?this.getIsWinInfoExisted(e.email)?(console.error("addAccountWinInfo error "+e.email+" existd."),!1):(this._accountWinInfos.push(e),this.updateAccountWinInfosToMainProcess(),window.electronLib.windowManage.getCurWindow().then((function(e){t.systemApi.addWindowHookConf(t._accountWinInfos.map((function(t){return{observerWinId:null==e?void 0:e.id,targetWinId:t.winId,hooksName:"onBeforeClose",hooksEventExtraData:{winId:t.winId,webId:t.webId,agentEmail:t.agentEmail,subAccountEmail:t.email,winType:"subAccountBg"}}})))})),!0):(console.error("addAccountWinInfo error param is invalid"),!1)},t.deleteBindAccount=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s,u,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t&&t.email&&t.agentEmail){e.next=3;break}return e.abrupt("return",this.getParamErrorResult());case 3:if(r=t.email,i=t.agentEmail,a=t.accountType,s="","qyEmail"!==a){e.next=10;break}s=this.systemApi.getUrl("deleteQiyeMailSubAccount"),e.next=15;break;case 10:if("personalEmail"!==a){e.next=14;break}s=this.systemApi.getUrl("deletePersonalSubAccount"),e.next=15;break;case 14:return e.abrupt("return",{success:!1,errMsg:"不支持的帐号类型",errCode:200});case 15:return e.next=17,this.httpApi.post(s,{email:i},{headers:A}).then((function(e){return e.data}));case 17:if(u=e.sent,"200"!==(null===(n=null==u?void 0:u.code)||void 0===n?void 0:n.toString())){e.next=28;break}return o=this.systemApi.getCurrentUser(),e.next=22,this.deleteLocalSubAccounts({mainAccountEmail:null==o?void 0:o.id,subAccountEmail:r});case 22:return e.next=24,this.deleteAllSubAccountDB(r);case 24:return this.sendSubAccountDeletedEvent(null==o?void 0:o.id,r,i),e.next=27,this.closeSubAccountWin(r);case 27:return e.abrupt("return",{success:!0});case 28:return e.abrupt("return",{success:!1,errMsg:null==u?void 0:u.err_msg,errCode:null==u?void 0:u.errorCode});case 31:return e.prev=31,e.t0=e.catch(0),e.abrupt("return",{success:!1,errMsg:e.t0.message,errCode:"deleteBindAccount-catch"});case 34:case"end":return e.stop()}}),e,this,[[0,31]])})));return function(){return e.apply(this,arguments)}}(),t.getCurrentAccount=function(){var e,t;return Object(d.l)()?window&&!window.electronLib?{email:(null===(e=this.systemApi.getCurrentUser())||void 0===e?void 0:e.id)||""}:this._currentAccountInfo||{email:(null===(t=this.systemApi.getCurrentUser())||void 0===t?void 0:t.id)||""}:null},t.setCurrentAccount=function(e){var t=this;if(Object(d.l)()&&(!window||window.electronLib)){if(0!==l()(e,"email.length",0)&&Promise.resolve().then((function(){t.setCurrentAccount({email:""})})),g&&g.length&&e){var n=g.find((function(t){return t.id===e.email||t.agentEmail===e.email}));if(n)return void(this._currentAccountInfo={email:n.id})}this._currentAccountInfo=e}},t.getAllSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.systemApi.getCurrentUser()){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,this.getBindAccountsFromServer();case 5:if(e.t0=e.sent,e.t0){e.next=8;break}e.t0=[];case 8:return n=e.t0,e.next=11,this.getSubAccounts({mainAccountEmail:t.id});case 11:return r=e.sent,n.forEach((function(e){var t,n="qyEmail"===e.accountType,a=e.accountEmail,c=r.find((function(e){return e.id===a}));e.password=n?"":c&&(null===(t=c.mainSendReceiveInfo)||void 0===t?void 0:t.password)||"",e.expired=!c||c.expired,i.addEmailTypeToSubAccount(e)})),e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.isSubAccount=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSubAccounts({expired:!1});case 2:return n=e.sent,r=n.find((function(e){return e.id===t})),e.abrupt("return",!!r);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getBindAccountsFromServer=function(){var e=Object(i.a)(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",Promise.all([this.getQiyeMailBindAccountsFromServer(),this.getPersonalBindAccountsFromServer()]).then((function(e){var t=e[0],n=e[1];if(null===t||null===n)return null;var r=e[0]||[],i=e[1]||[];return r.concat(i)})));case 4:return e.prev=4,e.t0=e.catch(0),console.error("getBindAccountsFromServer error",e.t0),e.abrupt("return",null);case 8:case"end":return e.stop()}}),e,this,[[0,4]])})));return function(){return e.apply(this,arguments)}}(),t.getQiyeMailBindAccountsFromServer=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.systemApi.getCurrentUser(),i=this.systemApi.getUrl("getQiyeMailBindSubAccounts"),e.next=5,this.httpApi.get(i,{},{headers:A}).then((function(e){return e.data}));case 5:if(a=e.sent,"200"!==(null===(t=null==a?void 0:a.code)||void 0===t?void 0:t.toString())){e.next=9;break}return s=(null===(n=null==a?void 0:a.result)||void 0===n?void 0:n.data)||[],e.abrupt("return",s.map((function(e){var t=u.systemApi.handleAccountAndDomain(e.email);return{accountType:"qyEmail",agentEmail:e.email,mainAccount:null==r?void 0:r.id,accountName:t.account,domain:t.domain,accountEmail:e.email,emailType:"NeteaseQiYeMail"}})));case 9:return e.abrupt("return",null);case 12:return e.prev=12,e.t0=e.catch(0),console.error("getQiyeMailBindAccountsFromServer error",e.t0),e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),t.getPersonalBindAccountsFromServer=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a,s,u=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.systemApi.getCurrentUser(),i=this.systemApi.getUrl("getBindPersonalSubAccounts"),e.next=5,this.httpApi.post(i,{},{headers:A}).then((function(e){return e.data}));case 5:if(a=e.sent,"200"!==(null===(t=null==a?void 0:a.code)||void 0===t?void 0:t.toString())){e.next=9;break}return s=(null===(n=null==a?void 0:a.result)||void 0===n?void 0:n.data)||[],e.abrupt("return",s.map((function(e){var t={accountType:"personalEmail",accountEmail:e.account_name+"@"+e.domain,mainAccount:null==r?void 0:r.id,accountName:e.account_name,domain:e.domain,agentEmail:e.agent_email,agentNickname:e.agent_nickname,sendHost:e.send_host,sendPort:e.send_port,sendSsl:e.send_ssl,receivePort:e.receive_port,receiveHost:e.receive_host,receiveSsl:e.receive_ssl};return u.addEmailTypeToSubAccount(t),t})));case 9:return e.abrupt("return",null);case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",null);case 15:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),t.editSubAccount=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"personalEmail"!==(n=t.accountType)){e.next=24;break}return e.next=5,this.editPersonSubAccount(t);case 5:if(!(r=e.sent).success){e.next=22;break}return i=Object.assign(Object.assign({},t),{password:t.password,agentEmail:t.agentEmail,accountType:"Others",isEditMode:!0}),a=this.systemApi.getCurrentUser(),e.next=11,this.getSubAccounts({mainAccountEmail:null==a?void 0:a.id,subAccountEmail:t.accountEmail});case 11:if(s=e.sent,!(u=s.find((function(e){return e.mainSendReceiveInfo&&e.mainSendReceiveInfo.agentEmail===t.agentEmail})))){e.next=19;break}return u.mainSendReceiveInfo=Object.assign(Object.assign({},u.mainSendReceiveInfo),t),u.nickName=t.agentNickname,u.expired=!1,e.next=19,this.addOrUpdateLocalSubAccounts([u]);case 19:return e.next=21,this.loginApi.bindSubAccount(i);case 21:r=e.sent;case 22:e.next=31;break;case 24:if("qyEmail"!==n){e.next=30;break}return e.next=27,this.editQiyeMailSubAccount(t);case 27:r=e.sent,e.next=31;break;case 30:return e.abrupt("return",{success:!1,errCode:100,errMsg:"不支持的账号类型"});case 31:return e.abrupt("return",r);case 34:return e.prev=34,e.t0=e.catch(0),e.abrupt("return",{success:!1,errMsg:e.t0.message,errCode:"editSubAccounts-error"});case 37:case"end":return e.stop()}}),e,this,[[0,34]])})));return function(){return e.apply(this,arguments)}}(),t.editQiyeMailSubAccount=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=t.agentEmail,r=t.password,n&&r){e.next=5;break}return e.abrupt("return",this.getParamErrorResult());case 5:return e.next=7,this.loginApi.bindSubAccount({accountType:"NeteaseQiYeMail",agentEmail:n,password:r,isEditMode:!0});case 7:return e.abrupt("return",e.sent);case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",{success:!1,errCode:"editQiyeMailSubAccount-catch",errMsg:e.t0.message});case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),t.editPersonSubAccount=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.systemApi.getUrl("editPersonalSubAccount"),i={current_email:t.agentEmail,email:t.agentEmail,password:t.password,send_host:t.sendHost,send_port:t.sendPort,send_ssl:t.sendSsl,receive_host:t.receiveHost,receive_port:t.receivePort,receive_ssl:t.receiveSsl,agent_nickname:t.agentNickname},e.next=5,this.httpApi.post(r,i,{headers:A}).then((function(e){return e.data}));case 5:if(a=e.sent,"200"!==(null===(n=null==a?void 0:a.code)||void 0===n?void 0:n.toString())){e.next=8;break}return e.abrupt("return",{success:!0});case 8:return s=null==a?void 0:a.errorCode,e.abrupt("return",{success:!1,errCode:null==a?void 0:a.errorCode,errMsg:m.c[s]||(null==a?void 0:a.err_msg)});case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",{success:!1,errCode:"editPersonSubAccount-catch",errMsg:e.t0.message});case 15:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),t.enableBackgroundPage=function(){try{this.systemApi.getIsLowMemoryModeSync()&&window.bridgeApi&&window.bridgeApi.master&&window.bridgeApi.master.enableBbWin4CurrPage()}catch(e){console.error("enableBackgroundPage catch",e)}},t.createSubAccountWin=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s,u,o,l,d,p,m,h;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=t.mainAccountEmail,r=t.subAccountEmail,i=t.sessionName,a=t.eventName,s=t.agentEmail,u=t.param,o=t.eventData,this.loginApi.createBKStableWindow(!0),this.enableBackgroundPage(),!this.getIsWinInfoExisted(r)){e.next=7;break}return e.abrupt("return");case 7:if(l=i||"persist:"+n+"-"+r,d=Object.assign({"open-account-bg-page":"true","main-account":n,"sub-account":r,"agent-account":s,sessionName:l},u||{}),"subAccountBg",p={type:"subAccountBg",additionalParams:d,manualShow:!0,sessionName:l,hooks:[{hooksName:"onBeforeClose",observerWinId:-1}]},!a){e.next=18;break}return h={sessionName:l},e.next=15,this.systemApi.createWindowWithInitData(p,{eventName:a,eventData:o?Object.assign(Object.assign({},h),o):h});case 15:m=e.sent,e.next=21;break;case 18:return e.next=20,this.systemApi.createWindow(p);case 20:m=e.sent;case 21:return m&&this.addAccountWinInfo({email:r,winId:m.winId,webId:m.webId,agentEmail:s}),e.abrupt("return",m);case 25:return e.prev=25,e.t0=e.catch(0),console.error("doCreateSubAccountWin-error",e.t0),e.abrupt("return",void 0);case 29:case"end":return e.stop()}}),e,this,[[0,25]])})));return function(){return e.apply(this,arguments)}}(),t.sendSubAccountDeletedEvent=function(e,t,n){this.eventApi.sendSysEvent({eventName:"SubAccountDeleted",eventData:{mainAccount:e,subAccount:t,agentEmail:n}})},t.closeSubAccountWin=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(n=this.getAccountWinInfos())&&n.length&&t&&(r=this.getAccountWinInfos({email:t}))&&r.length&&(i=r[0],this.removeAccountWinInfo(t),this.updateAccountWinInfosToMainProcess(),this.systemApi.closeSubWindow(i.winId,!0,!1));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.closeAllSubAccountWindows=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,window&&window.electronLib){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,window.electronLib.windowManage.getAllWinInfo();case 5:t=e.sent,t.filter((function(e){return"subAccountBg"===e.type})).forEach((function(e){var t=e.id;n.systemApi.closeSubWindow(t,!0,!1)})),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("closeAllSubAccountWindows-catch",e.t0);case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),t.initDeleteLocalSubAccounts=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r,i,a=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=this.systemApi.getCurrentUser()){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,this.getSubAccounts({mainAccountEmail:t.id});case 6:if((n=e.sent)&&n.length){e.next=9;break}return e.abrupt("return");case 9:return e.next=11,this.getBindAccountsFromServer();case 11:if(null!==(r=e.sent)){e.next=14;break}return e.abrupt("return");case 14:if(i=[],n.forEach((function(e){r&&r.length?r.find((function(t){return"qyEmail"===t.accountType?t.accountEmail===e.id:"personalEmail"===t.accountType&&(t.accountEmail===e.id&&t.agentEmail===e.agentEmail)}))||i.push(e.id):i.push(e.id)})),!i||!i.length){e.next=19;break}return e.next=19,Promise.all(i.map((function(e){a.deleteAllSubAccountDB(e);var t=a.systemApi.md5(e,!0);return a.DBApi.removeAccountAction(t),a.deleteLocalSubAccounts({subAccountEmail:e})})));case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(0),console.error("deleteLocalSubAccounts-error",e.t0);case 24:case"end":return e.stop()}}),e,this,[[0,21]])})));return function(){return e.apply(this,arguments)}}(),t.sendSubAccountExpiredEvent=function(e){this.eventApi.sendSysEvent({eventName:"SubAccountLoginExpired",eventData:e||{}})},t.initSubAccountWins=function(){var e=Object(i.a)(c.a.mark((function e(){var t,n,r=this;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isSubAccountInited){e.next=2;break}return e.abrupt("return");case 2:if(this.isSubAccountInited=!0,!(t=this.systemApi.isMainPage())){e.next=17;break}return this.updateAccountWinInfosToMainProcess(),e.next=8,this.closeAllSubAccountWindows();case 8:return e.next=10,this.initDeleteLocalSubAccounts();case 10:if(!(n=this.systemApi.getCurrentUser())){e.next=16;break}return e.next=14,this.getSubAccounts({mainAccountEmail:n.id,expired:!1});case 14:e.sent.forEach((function(e){r.createSubAccountWin({mainAccountEmail:n.id,agentEmail:e.agentEmail,subAccountEmail:e.id})}));case 16:this.eventApi.registerSysEventObserver("SubAccountLoginPreExpired",function(){var e=Object(i.a)(c.a.mark((function e(t){var n,i,a,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t||!t.eventData){e.next=11;break}return n=t.eventData,i=n.mainAccount,a=n.subAccount,s=n.agentEmail,e.next=5,r.getSubAccounts({mainAccountEmail:i,subAccountEmail:a});case 5:return(u=e.sent).forEach((function(e){e.expired=!0,r.closeSubAccountWin(e.id)})),e.next=9,r.addOrUpdateLocalSubAccounts(u);case 9:r.sendSubAccountExpiredEvent(n),r.sendSubAccountExpiredToServer(i,s);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}());case 17:Object(d.l)()&&t&&this.eventApi.registerSysEventObserver("electronClose",function(){var e=Object(i.a)(c.a.mark((function e(t){var n,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=t.eventData)){e.next=11;break}if((i=n.ext)&&i.winType){e.next=5;break}return e.abrupt("return");case 5:if("subAccountBg"===i.winType){e.next=8;break}return e.abrupt("return");case 8:a=r.systemApi.getCurrentUser(),r.removeAccountWinInfo(i.subAccountEmail),r.eventApi.sendSysEvent({eventName:"SubAccountWindowClosed",eventData:{webId:i.webId,winId:i.winId,mainAccount:null==a?void 0:a.id,subAccount:i.subAccountEmail,agentEmail:i.agentEmail}});case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}());case 18:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.sendSubAccountExpiredToServer=function(e,t){this.dataTrackApi.track("pcMail_accountFailure_agent",{mainAccount:e,agentEmail:t})},t.getParamErrorResult=function(){return{success:!1,errCode:"Param-Error",errMsg:"参数错误"}},t.getCatchErrorResult=function(e,t){return{success:!1,errCode:e+"-Catch",errMsg:t.message}},t.updateLocalNickName=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSubAccounts({subAccountEmail:t.email});case 2:if(!(n=e.sent)||!n.length){e.next=9;break}return(r=n[0]).nickName=t.nickName,r.mainSendReceiveInfo&&(r.mainSendReceiveInfo.agentNickname=t.nickName),e.next=9,this.addOrUpdateLocalSubAccounts([r]);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.editSubAccountNickName=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s,u;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.email,e.next=4,this.getSubAccounts({subAccountEmail:n,expired:!1});case 4:if((r=e.sent)&&r.length){e.next=7;break}return e.abrupt("return",{success:!0,errMsg:"SubAccount not exist",errCode:100});case 7:if(i=r[0],a=i.accountType,s=null,"personalEmail"!==a){e.next=18;break}return i.mainSendReceiveInfo.agentNickname=t.nickName,u=Object.assign(i,i.mainSendReceiveInfo||{}),e.next=15,this.editPersonSubAccount(u);case 15:s=e.sent,e.next=25;break;case 18:if("qyEmail"!==a){e.next=24;break}return e.next=21,this.setQiyeMailSubAccoutNickName(t);case 21:s=e.sent,e.next=25;break;case 24:s={success:!1,errMsg:"AccountType not support"};case 25:if(!s||!s.success){e.next=28;break}return e.next=28,this.updateLocalNickName(t);case 28:return e.abrupt("return",s||{success:!1});case 31:return e.prev=31,e.t0=e.catch(0),console.error("editSubAccountNickName-error",e.t0),e.abrupt("return",{success:!1});case 35:case"end":return e.stop()}}),e,this,[[0,31]])})));return function(){return e.apply(this,arguments)}}(),t.setQiyeMailSubAccoutNickName=function(){var e=Object(i.a)(c.a.mark((function e(t){var n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t&&t.email&&t.nickName){e.next=3;break}return e.abrupt("return",this.getParamErrorResult());case 3:return this.setCurrentAccount({email:t.email}),e.next=6,this.mailConfigApi.setMailSenderName(t.nickName.trim());case 6:if(!(n=e.sent)){e.next=10;break}return e.next=10,this.updateLocalNickName(t);case 10:return e.abrupt("return",{success:n});case 13:return e.prev=13,e.t0=e.catch(0),e.abrupt("return",this.getCatchErrorResult("setQiyeMailSubAccoutNickName",e.t0));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}(),t.getQiyeMailSubAccountNickName=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t&&t.email){e.next=3;break}return e.abrupt("return",this.getParamErrorResult());case 3:return this.setCurrentAccount({email:t.email}),e.next=6,this.mailConfigApi.getMailSenderInfo();case 6:if(n=e.sent,!(r=n.filter((function(e){return e.isMainEmail})))||!r.length){e.next=12;break}return i=r[0],a=i.senderName,e.abrupt("return",{success:!0,data:{nickName:a}});case 12:return e.abrupt("return",{success:!1,errCode:"no-main-acount",errMsg:"获取主帐号失败"});case 15:return e.prev=15,e.t0=e.catch(0),e.abrupt("return",this.getCatchErrorResult("getQiyeMailSubAccountNickName",e.t0));case 18:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),t.checkShareAccountExpired=function(e){var t=this;if(this.systemApi.isMainPage()){var n=this.systemApi.getCurrentUser();(null==n?void 0:n.isSharedAccount)&&(e?this.httpApi.triggerCurrentUserLogout(!0):this.getSharedAccountsInfoAsync(!0).then((function(e){e&&!e.isSharedAccountLogin&&t.httpApi.triggerCurrentUserLogout(!0)})))}},t.updateNodeInfoToAccount=function(){try{if(!window.isAccountBg)return;var e=this.systemApi.getCurrentUser();if(e&&!e.node){var t=this.storeApi.getCurrentNode();e.node=t,this.storeApi.setLastAccount(e),this.doSaveCurrentAccount(e)}}catch(n){console.error("updateNodeInfoToAccount error",n)}},t.afterLoadFinish=function(){var e=this.systemApi.isMainPage(),t=!!Object(d.l)()&&window.isAccountBg;return(e||t)&&this.systemApi.intervalEvent(this.updateAccountRefreshTokenHandle),this.initSubAccountWins(),this.checkShareAccountExpired(),this.name},t.getIsSharedAccountLoginAsync=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!y){e.next=3;break}return e.abrupt("return",y.isSharedAccountLogin);case 3:return e.next=5,this.getSharedAccountsInfoAsync(!0);case 5:if(!(t=e.sent)){e.next=8;break}return e.abrupt("return",t.isSharedAccountLogin);case 8:return e.abrupt("return",!1);case 11:return e.prev=11,e.t0=e.catch(0),console.error("getIsSharedAccountLoginAsync error",e.t0),e.abrupt("return",!1);case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));return function(){return e.apply(this,arguments)}}(),t.getIsSharedAccountAsync=function(){var e=Object(i.a)(c.a.mark((function e(){var t;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!y){e.next=3;break}return e.abrupt("return",y.isSharedAccount);case 3:return e.next=5,this.getSharedAccountsInfoAsync(!0);case 5:if(!(t=e.sent)){e.next=8;break}return e.abrupt("return",t.isSharedAccount);case 8:return e.abrupt("return",!1);case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this,[[0,11]])})));return function(){return e.apply(this,arguments)}}(),t.handleSharedAccountLogout=function(e){y&&(y.isSharedAccountLogin=!1,y.isSharedAccountExpired=!0,e&&y.sharedAccounts&&y.sharedAccounts.length&&(y.sharedAccounts=y.sharedAccounts.filter((function(t){return t.email!==e}))))},t.getSharedAccountsInfoAsync=function(){var e=Object(i.a)(c.a.mark((function e(t){var n,r,i,a,s,o,l,d,p,m,h,f,b,A;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=!1),e.prev=1,!y||t){e.next=4;break}return e.abrupt("return",u()(y));case 4:return a=this.systemApi.getUrl("getSharedAccounts"),e.next=7,this.httpApi.post(a).then((function(e){return e.data}));case 7:if(s=e.sent,"200"!==(o=null===(n=null==s?void 0:s.code)||void 0===n?void 0:n.toString())){e.next=24;break}if(l=s.result,d=(null==l?void 0:l.sharedAccounts)||[],p=this.systemApi.getCurrentUser(),m=(null==p?void 0:p.id)||"",h=!1,f=d.filter((function(e){return e.enabled})).map((function(e){return e.email===m?(e.isCurrentAccount=!0,h=!0):e.isCurrentAccount=!1,e})),b={isSharedAccount:!!h||((null==l?void 0:l.pub)||!1),isSharedAccountExpired:!1,email:null==l?void 0:l.email,nickName:null==l?void 0:l.nickName,alias:(null==l?void 0:l.alias)||[],isSharedAccountLogin:h,sharedAccounts:f},y=b,!p||!p.isSharedAccount){e.next=23;break}if(b.isSharedAccountLogin){e.next=23;break}return A={isSharedAccount:!0,isSharedAccountExpired:!0,email:(null===(r=p.originAccount)||void 0===r?void 0:r.email)||"",nickName:(null===(i=p.originAccount)||void 0===i?void 0:i.nickName)||"",alias:[],isSharedAccountLogin:!0,sharedAccounts:[{email:b.email,nickName:b.nickName,units:[""],enabled:!0,isCurrentAccount:!0,avatar:""}]},e.abrupt("return",A);case 23:return e.abrupt("return",u()(b));case 24:if("403"!==o){e.next=27;break}return this.checkShareAccountExpired(!0),e.abrupt("return",null);case 27:return console.error("getSharedAccountsAsync response error",s),e.abrupt("return",null);case 31:return e.prev=31,e.t0=e.catch(1),console.error("getSharedAccountsAsync catch error",e.t0),e.abrupt("return",null);case 35:case"end":return e.stop()}}),e,this,[[1,31]])})));return function(){return e.apply(this,arguments)}}(),t.getSubAccountsEmailType=function(e){var t=g.find((function(t){return t.id===e||t.agentEmail===e}));return(null==t?void 0:t.emailType)||"Others"},t.getAccountsEmailType=function(e){var t=this.systemApi.getCurrentUser();if(!t)return"Others";var n=[Object.assign(Object.assign({accountType:"mainAccount"},t),{emailType:"NeteaseQiYeMail",mainAccount:null==t?void 0:t.id,expired:!1,agentEmail:null==t?void 0:t.id})].concat(Object(r.a)(g)).find((function(t){return t.id===e||t.agentEmail===e}));return(null==n?void 0:n.emailType)||"Others"},e}();w.RndSyncRate=Math.floor(6*Math.random());var S=new w;p.a.registerLogicalApi(S),t.a=S}}]);